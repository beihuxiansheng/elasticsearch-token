begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to Elasticsearch under one or more contributor  * license agreements. See the NOTICE file distributed with  * this work for additional information regarding copyright  * ownership. Elasticsearch licenses this file to you under  * the Apache License, Version 2.0 (the "License"); you may  * not use this file except in compliance with the License.  * You may obtain a copy of the License at  *  *    http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing,  * software distributed under the License is distributed on an  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  * KIND, either express or implied.  See the License for the  * specific language governing permissions and limitations  * under the License.  */
end_comment

begin_package
DECL|package|org.elasticsearch.indices.analysis
package|package
name|org
operator|.
name|elasticsearch
operator|.
name|indices
operator|.
name|analysis
package|;
end_package

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|analysis
operator|.
name|hunspell
operator|.
name|Dictionary
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|IOUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|ElasticsearchException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|component
operator|.
name|AbstractComponent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|io
operator|.
name|FileSystemUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|settings
operator|.
name|Setting
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|settings
operator|.
name|Setting
operator|.
name|SettingsProperty
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|settings
operator|.
name|Settings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|env
operator|.
name|Environment
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|DirectoryStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|Files
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Locale
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ConcurrentHashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|function
operator|.
name|Function
import|;
end_import

begin_comment
comment|/**  * Serves as a node level registry for hunspell dictionaries. This services expects all dictionaries to be located under  * the {@code<path.conf>/hunspell} directory, where each locale has its dedicated sub-directory which holds the dictionary  * files. For example, the dictionary files for {@code en_US} locale must be placed under {@code<path.conf>/hunspell/en_US}  * directory.  *<p>  * The following settings can be set for each dictionary:  *<ul>  *<li>{@code ignore_case} - If true, dictionary matching will be case insensitive (defaults to {@code false})</li>  *<li>{@code strict_affix_parsing} - Determines whether errors while reading a affix rules file will cause exception or simple be ignored (defaults to {@code true})</li>  *</ul>  *<p>  * These settings can either be configured as node level configuration, such as:  *<br><br>  *<pre><code>  *     indices.analysis.hunspell.dictionary.en_US.ignore_case: true  *     indices.analysis.hunspell.dictionary.en_US.strict_affix_parsing: false  *</code></pre>  *<p>  * or, as dedicated configuration per dictionary, placed in a {@code settings.yml} file under the dictionary directory. For  * example, the following can be the content of the {@code<path.config>/hunspell/en_US/settings.yml} file:  *<br><br>  *<pre><code>  *     ignore_case: true  *     strict_affix_parsing: false  *</code></pre>  *  * @see org.elasticsearch.index.analysis.HunspellTokenFilterFactory  */
end_comment

begin_class
DECL|class|HunspellService
specifier|public
class|class
name|HunspellService
extends|extends
name|AbstractComponent
block|{
DECL|field|HUNSPELL_LAZY_LOAD
specifier|public
specifier|final
specifier|static
name|Setting
argument_list|<
name|Boolean
argument_list|>
name|HUNSPELL_LAZY_LOAD
init|=
name|Setting
operator|.
name|boolSetting
argument_list|(
literal|"indices.analysis.hunspell.dictionary.lazy"
argument_list|,
name|Boolean
operator|.
name|FALSE
argument_list|,
name|SettingsProperty
operator|.
name|ClusterScope
argument_list|)
decl_stmt|;
DECL|field|HUNSPELL_IGNORE_CASE
specifier|public
specifier|final
specifier|static
name|Setting
argument_list|<
name|Boolean
argument_list|>
name|HUNSPELL_IGNORE_CASE
init|=
name|Setting
operator|.
name|boolSetting
argument_list|(
literal|"indices.analysis.hunspell.dictionary.ignore_case"
argument_list|,
name|Boolean
operator|.
name|FALSE
argument_list|,
name|SettingsProperty
operator|.
name|ClusterScope
argument_list|)
decl_stmt|;
DECL|field|HUNSPELL_DICTIONARY_OPTIONS
specifier|public
specifier|final
specifier|static
name|Setting
argument_list|<
name|Settings
argument_list|>
name|HUNSPELL_DICTIONARY_OPTIONS
init|=
name|Setting
operator|.
name|groupSetting
argument_list|(
literal|"indices.analysis.hunspell.dictionary."
argument_list|,
name|SettingsProperty
operator|.
name|ClusterScope
argument_list|)
decl_stmt|;
DECL|field|dictionaries
specifier|private
specifier|final
name|ConcurrentHashMap
argument_list|<
name|String
argument_list|,
name|Dictionary
argument_list|>
name|dictionaries
init|=
operator|new
name|ConcurrentHashMap
argument_list|<>
argument_list|()
decl_stmt|;
DECL|field|knownDictionaries
specifier|private
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|Dictionary
argument_list|>
name|knownDictionaries
decl_stmt|;
DECL|field|defaultIgnoreCase
specifier|private
specifier|final
name|boolean
name|defaultIgnoreCase
decl_stmt|;
DECL|field|hunspellDir
specifier|private
specifier|final
name|Path
name|hunspellDir
decl_stmt|;
DECL|field|loadingFunction
specifier|private
specifier|final
name|Function
argument_list|<
name|String
argument_list|,
name|Dictionary
argument_list|>
name|loadingFunction
decl_stmt|;
DECL|method|HunspellService
specifier|public
name|HunspellService
parameter_list|(
specifier|final
name|Settings
name|settings
parameter_list|,
specifier|final
name|Environment
name|env
parameter_list|,
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|Dictionary
argument_list|>
name|knownDictionaries
parameter_list|)
throws|throws
name|IOException
block|{
name|super
argument_list|(
name|settings
argument_list|)
expr_stmt|;
name|this
operator|.
name|knownDictionaries
operator|=
name|Collections
operator|.
name|unmodifiableMap
argument_list|(
name|knownDictionaries
argument_list|)
expr_stmt|;
name|this
operator|.
name|hunspellDir
operator|=
name|resolveHunspellDirectory
argument_list|(
name|env
argument_list|)
expr_stmt|;
name|this
operator|.
name|defaultIgnoreCase
operator|=
name|HUNSPELL_IGNORE_CASE
operator|.
name|get
argument_list|(
name|settings
argument_list|)
expr_stmt|;
name|this
operator|.
name|loadingFunction
operator|=
parameter_list|(
name|locale
parameter_list|)
lambda|->
block|{
try|try
block|{
return|return
name|loadDictionary
argument_list|(
name|locale
argument_list|,
name|settings
argument_list|,
name|env
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"failed to load hunspell dictionary for locale: "
operator|+
name|locale
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
expr_stmt|;
if|if
condition|(
operator|!
name|HUNSPELL_LAZY_LOAD
operator|.
name|get
argument_list|(
name|settings
argument_list|)
condition|)
block|{
name|scanAndLoadDictionaries
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**      * Returns the hunspell dictionary for the given locale.      *      * @param locale The name of the locale      */
DECL|method|getDictionary
specifier|public
name|Dictionary
name|getDictionary
parameter_list|(
name|String
name|locale
parameter_list|)
block|{
name|Dictionary
name|dictionary
init|=
name|knownDictionaries
operator|.
name|get
argument_list|(
name|locale
argument_list|)
decl_stmt|;
if|if
condition|(
name|dictionary
operator|==
literal|null
condition|)
block|{
name|dictionary
operator|=
name|dictionaries
operator|.
name|computeIfAbsent
argument_list|(
name|locale
argument_list|,
name|loadingFunction
argument_list|)
expr_stmt|;
block|}
return|return
name|dictionary
return|;
block|}
DECL|method|resolveHunspellDirectory
specifier|private
name|Path
name|resolveHunspellDirectory
parameter_list|(
name|Environment
name|env
parameter_list|)
block|{
return|return
name|env
operator|.
name|configFile
argument_list|()
operator|.
name|resolve
argument_list|(
literal|"hunspell"
argument_list|)
return|;
block|}
comment|/**      * Scans the hunspell directory and loads all found dictionaries      */
DECL|method|scanAndLoadDictionaries
specifier|private
name|void
name|scanAndLoadDictionaries
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|Files
operator|.
name|isDirectory
argument_list|(
name|hunspellDir
argument_list|)
condition|)
block|{
try|try
init|(
name|DirectoryStream
argument_list|<
name|Path
argument_list|>
name|stream
init|=
name|Files
operator|.
name|newDirectoryStream
argument_list|(
name|hunspellDir
argument_list|)
init|)
block|{
for|for
control|(
name|Path
name|file
range|:
name|stream
control|)
block|{
if|if
condition|(
name|Files
operator|.
name|isDirectory
argument_list|(
name|file
argument_list|)
condition|)
block|{
try|try
init|(
name|DirectoryStream
argument_list|<
name|Path
argument_list|>
name|inner
init|=
name|Files
operator|.
name|newDirectoryStream
argument_list|(
name|hunspellDir
operator|.
name|resolve
argument_list|(
name|file
argument_list|)
argument_list|,
literal|"*.dic"
argument_list|)
init|)
block|{
if|if
condition|(
name|inner
operator|.
name|iterator
argument_list|()
operator|.
name|hasNext
argument_list|()
condition|)
block|{
comment|// just making sure it's indeed a dictionary dir
try|try
block|{
name|getDictionary
argument_list|(
name|file
operator|.
name|getFileName
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
comment|// The cache loader throws unchecked exception (see #loadDictionary()),
comment|// here we simply report the exception and continue loading the dictionaries
name|logger
operator|.
name|error
argument_list|(
literal|"exception while loading dictionary {}"
argument_list|,
name|e
argument_list|,
name|file
operator|.
name|getFileName
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
block|}
block|}
block|}
comment|/**      * Loads the hunspell dictionary for the given local.      *      * @param locale       The locale of the hunspell dictionary to be loaded.      * @param nodeSettings The node level settings      * @param env          The node environment (from which the conf path will be resolved)      * @return The loaded Hunspell dictionary      * @throws Exception when loading fails (due to IO errors or malformed dictionary files)      */
DECL|method|loadDictionary
specifier|private
name|Dictionary
name|loadDictionary
parameter_list|(
name|String
name|locale
parameter_list|,
name|Settings
name|nodeSettings
parameter_list|,
name|Environment
name|env
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|logger
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|logger
operator|.
name|debug
argument_list|(
literal|"Loading hunspell dictionary [{}]..."
argument_list|,
name|locale
argument_list|)
expr_stmt|;
block|}
name|Path
name|dicDir
init|=
name|hunspellDir
operator|.
name|resolve
argument_list|(
name|locale
argument_list|)
decl_stmt|;
if|if
condition|(
name|FileSystemUtils
operator|.
name|isAccessibleDirectory
argument_list|(
name|dicDir
argument_list|,
name|logger
argument_list|)
operator|==
literal|false
condition|)
block|{
throw|throw
operator|new
name|ElasticsearchException
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|Locale
operator|.
name|ROOT
argument_list|,
literal|"Could not find hunspell dictionary [%s]"
argument_list|,
name|locale
argument_list|)
argument_list|)
throw|;
block|}
comment|// merging node settings with hunspell dictionary specific settings
name|Settings
name|dictSettings
init|=
name|HUNSPELL_DICTIONARY_OPTIONS
operator|.
name|get
argument_list|(
name|nodeSettings
argument_list|)
decl_stmt|;
name|nodeSettings
operator|=
name|loadDictionarySettings
argument_list|(
name|dicDir
argument_list|,
name|dictSettings
operator|.
name|getByPrefix
argument_list|(
name|locale
argument_list|)
argument_list|)
expr_stmt|;
name|boolean
name|ignoreCase
init|=
name|nodeSettings
operator|.
name|getAsBoolean
argument_list|(
literal|"ignore_case"
argument_list|,
name|defaultIgnoreCase
argument_list|)
decl_stmt|;
name|Path
index|[]
name|affixFiles
init|=
name|FileSystemUtils
operator|.
name|files
argument_list|(
name|dicDir
argument_list|,
literal|"*.aff"
argument_list|)
decl_stmt|;
if|if
condition|(
name|affixFiles
operator|.
name|length
operator|==
literal|0
condition|)
block|{
throw|throw
operator|new
name|ElasticsearchException
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|Locale
operator|.
name|ROOT
argument_list|,
literal|"Missing affix file for hunspell dictionary [%s]"
argument_list|,
name|locale
argument_list|)
argument_list|)
throw|;
block|}
if|if
condition|(
name|affixFiles
operator|.
name|length
operator|!=
literal|1
condition|)
block|{
throw|throw
operator|new
name|ElasticsearchException
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|Locale
operator|.
name|ROOT
argument_list|,
literal|"Too many affix files exist for hunspell dictionary [%s]"
argument_list|,
name|locale
argument_list|)
argument_list|)
throw|;
block|}
name|InputStream
name|affixStream
init|=
literal|null
decl_stmt|;
name|Path
index|[]
name|dicFiles
init|=
name|FileSystemUtils
operator|.
name|files
argument_list|(
name|dicDir
argument_list|,
literal|"*.dic"
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|InputStream
argument_list|>
name|dicStreams
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|dicFiles
operator|.
name|length
argument_list|)
decl_stmt|;
try|try
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|dicFiles
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|dicStreams
operator|.
name|add
argument_list|(
name|Files
operator|.
name|newInputStream
argument_list|(
name|dicFiles
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|affixStream
operator|=
name|Files
operator|.
name|newInputStream
argument_list|(
name|affixFiles
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|new
name|Dictionary
argument_list|(
name|affixStream
argument_list|,
name|dicStreams
argument_list|,
name|ignoreCase
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|logger
operator|.
name|error
argument_list|(
literal|"Could not load hunspell dictionary [{}]"
argument_list|,
name|e
argument_list|,
name|locale
argument_list|)
expr_stmt|;
throw|throw
name|e
throw|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|close
argument_list|(
name|affixStream
argument_list|)
expr_stmt|;
name|IOUtils
operator|.
name|close
argument_list|(
name|dicStreams
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**      * Each hunspell dictionary directory may contain a {@code settings.yml} which holds dictionary specific settings. Default      * values for these settings are defined in the given default settings.      *      * @param dir      The directory of the dictionary      * @param defaults The default settings for this dictionary      * @return The resolved settings.      */
DECL|method|loadDictionarySettings
specifier|private
specifier|static
name|Settings
name|loadDictionarySettings
parameter_list|(
name|Path
name|dir
parameter_list|,
name|Settings
name|defaults
parameter_list|)
block|{
name|Path
name|file
init|=
name|dir
operator|.
name|resolve
argument_list|(
literal|"settings.yml"
argument_list|)
decl_stmt|;
if|if
condition|(
name|Files
operator|.
name|exists
argument_list|(
name|file
argument_list|)
condition|)
block|{
return|return
name|Settings
operator|.
name|settingsBuilder
argument_list|()
operator|.
name|loadFromPath
argument_list|(
name|file
argument_list|)
operator|.
name|put
argument_list|(
name|defaults
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
name|file
operator|=
name|dir
operator|.
name|resolve
argument_list|(
literal|"settings.json"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Files
operator|.
name|exists
argument_list|(
name|file
argument_list|)
condition|)
block|{
return|return
name|Settings
operator|.
name|settingsBuilder
argument_list|()
operator|.
name|loadFromPath
argument_list|(
name|file
argument_list|)
operator|.
name|put
argument_list|(
name|defaults
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
return|return
name|defaults
return|;
block|}
block|}
end_class

end_unit

