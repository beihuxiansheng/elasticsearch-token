begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to Elasticsearch under one or more contributor  * license agreements. See the NOTICE file distributed with  * this work for additional information regarding copyright  * ownership. Elasticsearch licenses this file to you under  * the Apache License, Version 2.0 (the "License"); you may  * not use this file except in compliance with the License.  * You may obtain a copy of the License at  *  *    http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing,  * software distributed under the License is distributed on an  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  * KIND, either express or implied.  See the License for the  * specific language governing permissions and limitations  * under the License.  */
end_comment

begin_package
DECL|package|org.elasticsearch.cluster.routing.allocation
package|package
name|org
operator|.
name|elasticsearch
operator|.
name|cluster
operator|.
name|routing
operator|.
name|allocation
package|;
end_package

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|cluster
operator|.
name|routing
operator|.
name|UnassignedInfo
operator|.
name|AllocationStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|cluster
operator|.
name|routing
operator|.
name|allocation
operator|.
name|decider
operator|.
name|Decision
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|cluster
operator|.
name|routing
operator|.
name|allocation
operator|.
name|decider
operator|.
name|Decision
operator|.
name|Type
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|Nullable
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Objects
import|;
end_import

begin_comment
comment|/**  * Represents the allocation decision by an allocator for an unassigned shard.  */
end_comment

begin_class
DECL|class|AllocateUnassignedDecision
specifier|public
class|class
name|AllocateUnassignedDecision
block|{
comment|/** a constant representing a shard decision where no decision was taken */
DECL|field|NOT_TAKEN
specifier|public
specifier|static
specifier|final
name|AllocateUnassignedDecision
name|NOT_TAKEN
init|=
operator|new
name|AllocateUnassignedDecision
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
decl_stmt|;
comment|/**      * a map of cached common no/throttle decisions that don't need explanations,      * this helps prevent unnecessary object allocations for the non-explain API case      */
DECL|field|CACHED_DECISIONS
specifier|private
specifier|static
specifier|final
name|Map
argument_list|<
name|AllocationStatus
argument_list|,
name|AllocateUnassignedDecision
argument_list|>
name|CACHED_DECISIONS
decl_stmt|;
static|static
block|{
name|Map
argument_list|<
name|AllocationStatus
argument_list|,
name|AllocateUnassignedDecision
argument_list|>
name|cachedDecisions
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|cachedDecisions
operator|.
name|put
argument_list|(
name|AllocationStatus
operator|.
name|FETCHING_SHARD_DATA
argument_list|,
operator|new
name|AllocateUnassignedDecision
argument_list|(
name|Type
operator|.
name|NO
argument_list|,
name|AllocationStatus
operator|.
name|FETCHING_SHARD_DATA
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
name|cachedDecisions
operator|.
name|put
argument_list|(
name|AllocationStatus
operator|.
name|NO_VALID_SHARD_COPY
argument_list|,
operator|new
name|AllocateUnassignedDecision
argument_list|(
name|Type
operator|.
name|NO
argument_list|,
name|AllocationStatus
operator|.
name|NO_VALID_SHARD_COPY
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
name|cachedDecisions
operator|.
name|put
argument_list|(
name|AllocationStatus
operator|.
name|DECIDERS_NO
argument_list|,
operator|new
name|AllocateUnassignedDecision
argument_list|(
name|Type
operator|.
name|NO
argument_list|,
name|AllocationStatus
operator|.
name|DECIDERS_NO
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
name|cachedDecisions
operator|.
name|put
argument_list|(
name|AllocationStatus
operator|.
name|DECIDERS_THROTTLED
argument_list|,
operator|new
name|AllocateUnassignedDecision
argument_list|(
name|Type
operator|.
name|THROTTLE
argument_list|,
name|AllocationStatus
operator|.
name|DECIDERS_THROTTLED
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
name|cachedDecisions
operator|.
name|put
argument_list|(
name|AllocationStatus
operator|.
name|DELAYED_ALLOCATION
argument_list|,
operator|new
name|AllocateUnassignedDecision
argument_list|(
name|Type
operator|.
name|NO
argument_list|,
name|AllocationStatus
operator|.
name|DELAYED_ALLOCATION
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
name|CACHED_DECISIONS
operator|=
name|Collections
operator|.
name|unmodifiableMap
argument_list|(
name|cachedDecisions
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Nullable
DECL|field|finalDecision
specifier|private
specifier|final
name|Type
name|finalDecision
decl_stmt|;
annotation|@
name|Nullable
DECL|field|allocationStatus
specifier|private
specifier|final
name|AllocationStatus
name|allocationStatus
decl_stmt|;
annotation|@
name|Nullable
DECL|field|finalExplanation
specifier|private
specifier|final
name|String
name|finalExplanation
decl_stmt|;
annotation|@
name|Nullable
DECL|field|assignedNodeId
specifier|private
specifier|final
name|String
name|assignedNodeId
decl_stmt|;
annotation|@
name|Nullable
DECL|field|allocationId
specifier|private
specifier|final
name|String
name|allocationId
decl_stmt|;
annotation|@
name|Nullable
DECL|field|nodeDecisions
specifier|private
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|NodeAllocationResult
argument_list|>
name|nodeDecisions
decl_stmt|;
annotation|@
name|Nullable
DECL|field|shardDecision
specifier|private
specifier|final
name|Decision
name|shardDecision
decl_stmt|;
DECL|method|AllocateUnassignedDecision
specifier|private
name|AllocateUnassignedDecision
parameter_list|(
name|Type
name|finalDecision
parameter_list|,
name|AllocationStatus
name|allocationStatus
parameter_list|,
name|String
name|finalExplanation
parameter_list|,
name|String
name|assignedNodeId
parameter_list|,
name|String
name|allocationId
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|NodeAllocationResult
argument_list|>
name|nodeDecisions
parameter_list|,
name|Decision
name|shardDecision
parameter_list|)
block|{
assert|assert
name|assignedNodeId
operator|!=
literal|null
operator|||
name|finalDecision
operator|==
literal|null
operator|||
name|finalDecision
operator|!=
name|Type
operator|.
name|YES
operator|:
literal|"a yes decision must have a node to assign the shard to"
assert|;
assert|assert
name|allocationStatus
operator|!=
literal|null
operator|||
name|finalDecision
operator|==
literal|null
operator|||
name|finalDecision
operator|==
name|Type
operator|.
name|YES
operator|:
literal|"only a yes decision should not have an allocation status"
assert|;
assert|assert
name|allocationId
operator|==
literal|null
operator|||
name|assignedNodeId
operator|!=
literal|null
operator|:
literal|"allocation id can only be null if the assigned node is null"
assert|;
name|this
operator|.
name|finalDecision
operator|=
name|finalDecision
expr_stmt|;
name|this
operator|.
name|allocationStatus
operator|=
name|allocationStatus
expr_stmt|;
name|this
operator|.
name|finalExplanation
operator|=
name|finalExplanation
expr_stmt|;
name|this
operator|.
name|assignedNodeId
operator|=
name|assignedNodeId
expr_stmt|;
name|this
operator|.
name|allocationId
operator|=
name|allocationId
expr_stmt|;
name|this
operator|.
name|nodeDecisions
operator|=
name|nodeDecisions
operator|!=
literal|null
condition|?
name|Collections
operator|.
name|unmodifiableMap
argument_list|(
name|nodeDecisions
argument_list|)
else|:
literal|null
expr_stmt|;
name|this
operator|.
name|shardDecision
operator|=
name|shardDecision
expr_stmt|;
block|}
comment|/**      * Returns a NO decision with the given shard-level decision and explanation (if in explain mode).      */
DECL|method|no
specifier|public
specifier|static
name|AllocateUnassignedDecision
name|no
parameter_list|(
name|Decision
name|shardDecision
parameter_list|,
annotation|@
name|Nullable
name|String
name|explanation
parameter_list|)
block|{
if|if
condition|(
name|explanation
operator|!=
literal|null
condition|)
block|{
return|return
operator|new
name|AllocateUnassignedDecision
argument_list|(
name|Type
operator|.
name|NO
argument_list|,
name|AllocationStatus
operator|.
name|DECIDERS_NO
argument_list|,
name|explanation
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
name|shardDecision
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|getCachedDecision
argument_list|(
name|AllocationStatus
operator|.
name|DECIDERS_NO
argument_list|)
return|;
block|}
block|}
comment|/**      * Returns a NO decision with the given {@link AllocationStatus} and explanation for the NO decision, if in explain mode.      */
DECL|method|no
specifier|public
specifier|static
name|AllocateUnassignedDecision
name|no
parameter_list|(
name|AllocationStatus
name|allocationStatus
parameter_list|,
annotation|@
name|Nullable
name|String
name|explanation
parameter_list|)
block|{
return|return
name|no
argument_list|(
name|allocationStatus
argument_list|,
name|explanation
argument_list|,
literal|null
argument_list|)
return|;
block|}
comment|/**      * Returns a NO decision with the given {@link AllocationStatus}, and the explanation for the NO decision      * as well as the individual node-level decisions that comprised the final NO decision if in explain mode.      */
DECL|method|no
specifier|public
specifier|static
name|AllocateUnassignedDecision
name|no
parameter_list|(
name|AllocationStatus
name|allocationStatus
parameter_list|,
annotation|@
name|Nullable
name|String
name|explanation
parameter_list|,
annotation|@
name|Nullable
name|Map
argument_list|<
name|String
argument_list|,
name|Decision
argument_list|>
name|nodeDecisions
parameter_list|)
block|{
name|Objects
operator|.
name|requireNonNull
argument_list|(
name|allocationStatus
argument_list|,
literal|"allocationStatus must not be null"
argument_list|)
expr_stmt|;
if|if
condition|(
name|explanation
operator|!=
literal|null
condition|)
block|{
return|return
operator|new
name|AllocateUnassignedDecision
argument_list|(
name|Type
operator|.
name|NO
argument_list|,
name|allocationStatus
argument_list|,
name|explanation
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
name|asExplanations
argument_list|(
name|nodeDecisions
argument_list|)
argument_list|,
literal|null
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|getCachedDecision
argument_list|(
name|allocationStatus
argument_list|)
return|;
block|}
block|}
comment|/**      * Returns a THROTTLE decision, with the given explanation and individual node-level decisions that      * comprised the final THROTTLE decision if in explain mode.      */
DECL|method|throttle
specifier|public
specifier|static
name|AllocateUnassignedDecision
name|throttle
parameter_list|(
annotation|@
name|Nullable
name|String
name|explanation
parameter_list|,
annotation|@
name|Nullable
name|Map
argument_list|<
name|String
argument_list|,
name|Decision
argument_list|>
name|nodeDecisions
parameter_list|)
block|{
if|if
condition|(
name|explanation
operator|!=
literal|null
condition|)
block|{
return|return
operator|new
name|AllocateUnassignedDecision
argument_list|(
name|Type
operator|.
name|THROTTLE
argument_list|,
name|AllocationStatus
operator|.
name|DECIDERS_THROTTLED
argument_list|,
name|explanation
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|,
name|asExplanations
argument_list|(
name|nodeDecisions
argument_list|)
argument_list|,
literal|null
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|getCachedDecision
argument_list|(
name|AllocationStatus
operator|.
name|DECIDERS_THROTTLED
argument_list|)
return|;
block|}
block|}
comment|/**      * Creates a YES decision with the given explanation and individual node-level decisions that      * comprised the final YES decision, along with the node id to which the shard is assigned and      * the allocation id for the shard, if available.      */
DECL|method|yes
specifier|public
specifier|static
name|AllocateUnassignedDecision
name|yes
parameter_list|(
name|String
name|assignedNodeId
parameter_list|,
annotation|@
name|Nullable
name|String
name|explanation
parameter_list|,
annotation|@
name|Nullable
name|String
name|allocationId
parameter_list|,
annotation|@
name|Nullable
name|Map
argument_list|<
name|String
argument_list|,
name|Decision
argument_list|>
name|nodeDecisions
parameter_list|)
block|{
name|Objects
operator|.
name|requireNonNull
argument_list|(
name|assignedNodeId
argument_list|,
literal|"assignedNodeId must not be null"
argument_list|)
expr_stmt|;
return|return
operator|new
name|AllocateUnassignedDecision
argument_list|(
name|Type
operator|.
name|YES
argument_list|,
literal|null
argument_list|,
name|explanation
argument_list|,
name|assignedNodeId
argument_list|,
name|allocationId
argument_list|,
name|asExplanations
argument_list|(
name|nodeDecisions
argument_list|)
argument_list|,
literal|null
argument_list|)
return|;
block|}
comment|/**      * Creates a {@link AllocateUnassignedDecision} from the given {@link Decision} and the assigned node, if any.      */
DECL|method|fromDecision
specifier|public
specifier|static
name|AllocateUnassignedDecision
name|fromDecision
parameter_list|(
name|Decision
name|decision
parameter_list|,
annotation|@
name|Nullable
name|String
name|assignedNodeId
parameter_list|,
name|boolean
name|explain
parameter_list|,
annotation|@
name|Nullable
name|Map
argument_list|<
name|String
argument_list|,
name|NodeAllocationResult
argument_list|>
name|nodeDecisions
parameter_list|)
block|{
specifier|final
name|Type
name|decisionType
init|=
name|decision
operator|.
name|type
argument_list|()
decl_stmt|;
name|AllocationStatus
name|allocationStatus
init|=
name|decisionType
operator|!=
name|Type
operator|.
name|YES
condition|?
name|AllocationStatus
operator|.
name|fromDecision
argument_list|(
name|decisionType
argument_list|)
else|:
literal|null
decl_stmt|;
name|String
name|explanation
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|explain
condition|)
block|{
if|if
condition|(
name|decision
operator|.
name|type
argument_list|()
operator|==
name|Type
operator|.
name|YES
condition|)
block|{
assert|assert
name|assignedNodeId
operator|!=
literal|null
assert|;
name|explanation
operator|=
literal|"shard assigned to node ["
operator|+
name|assignedNodeId
operator|+
literal|"]"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|decision
operator|.
name|type
argument_list|()
operator|==
name|Type
operator|.
name|THROTTLE
condition|)
block|{
assert|assert
name|assignedNodeId
operator|!=
literal|null
assert|;
name|explanation
operator|=
literal|"shard assignment throttled on node ["
operator|+
name|assignedNodeId
operator|+
literal|"]"
expr_stmt|;
block|}
else|else
block|{
name|explanation
operator|=
literal|"shard cannot be assigned to any node in the cluster"
expr_stmt|;
block|}
block|}
return|return
operator|new
name|AllocateUnassignedDecision
argument_list|(
name|decisionType
argument_list|,
name|allocationStatus
argument_list|,
name|explanation
argument_list|,
name|assignedNodeId
argument_list|,
literal|null
argument_list|,
name|nodeDecisions
argument_list|,
literal|null
argument_list|)
return|;
block|}
DECL|method|getCachedDecision
specifier|private
specifier|static
name|AllocateUnassignedDecision
name|getCachedDecision
parameter_list|(
name|AllocationStatus
name|allocationStatus
parameter_list|)
block|{
name|AllocateUnassignedDecision
name|decision
init|=
name|CACHED_DECISIONS
operator|.
name|get
argument_list|(
name|allocationStatus
argument_list|)
decl_stmt|;
return|return
name|Objects
operator|.
name|requireNonNull
argument_list|(
name|decision
argument_list|,
literal|"precomputed decision not found for "
operator|+
name|allocationStatus
argument_list|)
return|;
block|}
DECL|method|asExplanations
specifier|private
specifier|static
name|Map
argument_list|<
name|String
argument_list|,
name|NodeAllocationResult
argument_list|>
name|asExplanations
parameter_list|(
name|Map
argument_list|<
name|String
argument_list|,
name|Decision
argument_list|>
name|decisionMap
parameter_list|)
block|{
if|if
condition|(
name|decisionMap
operator|!=
literal|null
condition|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|NodeAllocationResult
argument_list|>
name|explanationMap
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|Decision
argument_list|>
name|entry
range|:
name|decisionMap
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|explanationMap
operator|.
name|put
argument_list|(
name|entry
operator|.
name|getKey
argument_list|()
argument_list|,
operator|new
name|NodeAllocationResult
argument_list|(
name|entry
operator|.
name|getValue
argument_list|()
argument_list|,
name|Float
operator|.
name|POSITIVE_INFINITY
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|explanationMap
return|;
block|}
return|return
literal|null
return|;
block|}
comment|/**      * Returns<code>true</code> if a decision was taken by the allocator, {@code false} otherwise.      * If no decision was taken, then the rest of the fields in this object are meaningless and return {@code null}.      */
DECL|method|isDecisionTaken
specifier|public
name|boolean
name|isDecisionTaken
parameter_list|()
block|{
return|return
name|finalDecision
operator|!=
literal|null
return|;
block|}
comment|/**      * Returns the final decision made by the allocator on whether to assign the shard.      * This value can only be {@code null} if {@link #isDecisionTaken()} returns {@code false}.      */
annotation|@
name|Nullable
DECL|method|getFinalDecisionType
specifier|public
name|Type
name|getFinalDecisionType
parameter_list|()
block|{
return|return
name|finalDecision
return|;
block|}
comment|/**      * Returns the final decision made by the allocator on whether to assign the shard.      * Only call this method if {@link #isDecisionTaken()} returns {@code true}, otherwise it will      * throw an {@code IllegalArgumentException}.      */
DECL|method|getFinalDecisionSafe
specifier|public
name|Type
name|getFinalDecisionSafe
parameter_list|()
block|{
if|if
condition|(
name|isDecisionTaken
argument_list|()
operator|==
literal|false
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"decision must have been taken in order to return the final decision"
argument_list|)
throw|;
block|}
return|return
name|finalDecision
return|;
block|}
comment|/**      * Returns the status of an unsuccessful allocation attempt.  This value will be {@code null} if      * no decision was taken or if the decision was {@link Decision.Type#YES}.      */
annotation|@
name|Nullable
DECL|method|getAllocationStatus
specifier|public
name|AllocationStatus
name|getAllocationStatus
parameter_list|()
block|{
return|return
name|allocationStatus
return|;
block|}
comment|/**      * Returns the free-text explanation for the reason behind the decision taken in {@link #getFinalDecisionType()}.      */
annotation|@
name|Nullable
DECL|method|getFinalExplanation
specifier|public
name|String
name|getFinalExplanation
parameter_list|()
block|{
return|return
name|finalExplanation
return|;
block|}
comment|/**      * Get the node id that the allocator will assign the shard to, unless {@link #getFinalDecisionType()} returns      * a value other than {@link Decision.Type#YES}, in which case this returns {@code null}.      */
annotation|@
name|Nullable
DECL|method|getAssignedNodeId
specifier|public
name|String
name|getAssignedNodeId
parameter_list|()
block|{
return|return
name|assignedNodeId
return|;
block|}
comment|/**      * Gets the allocation id for the existing shard copy that the allocator is assigning the shard to.      * This method returns a non-null value iff {@link #getAssignedNodeId()} returns a non-null value      * and the node on which the shard is assigned already has a shard copy with an in-sync allocation id      * that we can re-use.      */
annotation|@
name|Nullable
DECL|method|getAllocationId
specifier|public
name|String
name|getAllocationId
parameter_list|()
block|{
return|return
name|allocationId
return|;
block|}
comment|/**      * Gets the individual node-level decisions that went into making the final decision as represented by      * {@link #getFinalDecisionType()}.  The map that is returned has the node id as the key and a {@link Decision}      * as the decision for the given node.      */
annotation|@
name|Nullable
DECL|method|getNodeDecisions
specifier|public
name|Map
argument_list|<
name|String
argument_list|,
name|NodeAllocationResult
argument_list|>
name|getNodeDecisions
parameter_list|()
block|{
return|return
name|nodeDecisions
return|;
block|}
comment|/**      * Gets the decision on allocating a shard, without examining any specific nodes to allocate to      * (e.g. a replica can never be allocated if the primary is not allocated, so this is a shard-level      * decision, not having taken any node into account).      */
annotation|@
name|Nullable
DECL|method|getShardDecision
specifier|public
name|Decision
name|getShardDecision
parameter_list|()
block|{
return|return
name|shardDecision
return|;
block|}
block|}
end_class

end_unit

