begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to Elasticsearch under one or more contributor  * license agreements. See the NOTICE file distributed with  * this work for additional information regarding copyright  * ownership. Elasticsearch licenses this file to you under  * the Apache License, Version 2.0 (the "License"); you may  * not use this file except in compliance with the License.  * You may obtain a copy of the License at  *  *    http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing,  * software distributed under the License is distributed on an  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  * KIND, either express or implied.  See the License for the  * specific language governing permissions and limitations  * under the License.  */
end_comment

begin_package
DECL|package|org.elasticsearch.indices.analysis
package|package
name|org
operator|.
name|elasticsearch
operator|.
name|indices
operator|.
name|analysis
package|;
end_package

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|CacheBuilder
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|CacheLoader
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|LoadingCache
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|util
operator|.
name|concurrent
operator|.
name|UncheckedExecutionException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|analysis
operator|.
name|hunspell
operator|.
name|Dictionary
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|ElasticsearchException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|component
operator|.
name|AbstractComponent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|inject
operator|.
name|Inject
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|io
operator|.
name|FileSystemUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|io
operator|.
name|PathUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|settings
operator|.
name|ImmutableSettings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|settings
operator|.
name|Settings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|env
operator|.
name|Environment
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|DirectoryStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|Files
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|Paths
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|*
import|;
end_import

begin_comment
comment|/**  * Serves as a node level registry for hunspell dictionaries. This services expects all dictionaries to be located under  * the {@code<path.conf>/hunspell} directory, where each locale has its dedicated sub-directory which holds the dictionary  * files. For example, the dictionary files for {@code en_US} locale must be placed under {@code<path.conf>/hunspell/en_US}  * directory.  *<p/>  * The following settings can be set for each dictionary:  *<ul>  *<li>{@code ignore_case} - If true, dictionary matching will be case insensitive (defaults to {@code false})</li>  *<li>{@code strict_affix_parsing} - Determines whether errors while reading a affix rules file will cause exception or simple be ignored (defaults to {@code true})</li>  *</ul>  *<p/>  * These settings can either be configured as node level configuration, such as:  *<br/><br/>  *<pre><code>  *     indices.analysis.hunspell.dictionary.en_US.ignore_case: true  *     indices.analysis.hunspell.dictionary.en_US.strict_affix_parsing: false  *</code></pre>  *<p/>  * or, as dedicated configuration per dictionary, placed in a {@code settings.yml} file under the dictionary directory. For  * example, the following can be the content of the {@code<path.config>/hunspell/en_US/settings.yml} file:  *<br/><br/>  *<pre><code>  *     ignore_case: true  *     strict_affix_parsing: false  *</code></pre>  *  * @see org.elasticsearch.index.analysis.HunspellTokenFilterFactory  */
end_comment

begin_class
DECL|class|HunspellService
specifier|public
class|class
name|HunspellService
extends|extends
name|AbstractComponent
block|{
DECL|field|HUNSPELL_LAZY_LOAD
specifier|public
specifier|final
specifier|static
name|String
name|HUNSPELL_LAZY_LOAD
init|=
literal|"indices.analysis.hunspell.dictionary.lazy"
decl_stmt|;
DECL|field|HUNSPELL_IGNORE_CASE
specifier|public
specifier|final
specifier|static
name|String
name|HUNSPELL_IGNORE_CASE
init|=
literal|"indices.analysis.hunspell.dictionary.ignore_case"
decl_stmt|;
DECL|field|OLD_HUNSPELL_LOCATION
specifier|private
specifier|final
specifier|static
name|String
name|OLD_HUNSPELL_LOCATION
init|=
literal|"indices.analysis.hunspell.dictionary.location"
decl_stmt|;
DECL|field|dictionaries
specifier|private
specifier|final
name|LoadingCache
argument_list|<
name|String
argument_list|,
name|Dictionary
argument_list|>
name|dictionaries
decl_stmt|;
DECL|field|knownDictionaries
specifier|private
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|Dictionary
argument_list|>
name|knownDictionaries
decl_stmt|;
DECL|field|defaultIgnoreCase
specifier|private
specifier|final
name|boolean
name|defaultIgnoreCase
decl_stmt|;
DECL|field|hunspellDir
specifier|private
specifier|final
name|Path
name|hunspellDir
decl_stmt|;
DECL|method|HunspellService
specifier|public
name|HunspellService
parameter_list|(
specifier|final
name|Settings
name|settings
parameter_list|,
specifier|final
name|Environment
name|env
parameter_list|)
throws|throws
name|IOException
block|{
name|this
argument_list|(
name|settings
argument_list|,
name|env
argument_list|,
name|Collections
operator|.
expr|<
name|String
argument_list|,
name|Dictionary
operator|>
name|emptyMap
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Inject
DECL|method|HunspellService
specifier|public
name|HunspellService
parameter_list|(
specifier|final
name|Settings
name|settings
parameter_list|,
specifier|final
name|Environment
name|env
parameter_list|,
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|Dictionary
argument_list|>
name|knownDictionaries
parameter_list|)
throws|throws
name|IOException
block|{
name|super
argument_list|(
name|settings
argument_list|)
expr_stmt|;
name|this
operator|.
name|knownDictionaries
operator|=
name|knownDictionaries
expr_stmt|;
name|this
operator|.
name|hunspellDir
operator|=
name|resolveHunspellDirectory
argument_list|(
name|settings
argument_list|,
name|env
argument_list|)
expr_stmt|;
name|this
operator|.
name|defaultIgnoreCase
operator|=
name|settings
operator|.
name|getAsBoolean
argument_list|(
name|HUNSPELL_IGNORE_CASE
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|dictionaries
operator|=
name|CacheBuilder
operator|.
name|newBuilder
argument_list|()
operator|.
name|build
argument_list|(
operator|new
name|CacheLoader
argument_list|<
name|String
argument_list|,
name|Dictionary
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Dictionary
name|load
parameter_list|(
name|String
name|locale
parameter_list|)
throws|throws
name|Exception
block|{
name|Dictionary
name|dictionary
init|=
name|knownDictionaries
operator|.
name|get
argument_list|(
name|locale
argument_list|)
decl_stmt|;
if|if
condition|(
name|dictionary
operator|==
literal|null
condition|)
block|{
name|dictionary
operator|=
name|loadDictionary
argument_list|(
name|locale
argument_list|,
name|settings
argument_list|,
name|env
argument_list|)
expr_stmt|;
block|}
return|return
name|dictionary
return|;
block|}
block|}
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|settings
operator|.
name|getAsBoolean
argument_list|(
name|HUNSPELL_LAZY_LOAD
argument_list|,
literal|false
argument_list|)
condition|)
block|{
name|scanAndLoadDictionaries
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**      * Returns the hunspell dictionary for the given locale.      *      * @param locale The name of the locale      */
DECL|method|getDictionary
specifier|public
name|Dictionary
name|getDictionary
parameter_list|(
name|String
name|locale
parameter_list|)
block|{
return|return
name|dictionaries
operator|.
name|getUnchecked
argument_list|(
name|locale
argument_list|)
return|;
block|}
DECL|method|resolveHunspellDirectory
specifier|private
name|Path
name|resolveHunspellDirectory
parameter_list|(
name|Settings
name|settings
parameter_list|,
name|Environment
name|env
parameter_list|)
block|{
name|String
name|location
init|=
name|settings
operator|.
name|get
argument_list|(
name|OLD_HUNSPELL_LOCATION
argument_list|,
literal|null
argument_list|)
decl_stmt|;
if|if
condition|(
name|location
operator|!=
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"please, put your hunspell dictionaries under config/hunspell !"
argument_list|)
throw|;
block|}
return|return
name|env
operator|.
name|configFile
argument_list|()
operator|.
name|resolve
argument_list|(
literal|"hunspell"
argument_list|)
return|;
block|}
comment|/**      * Scans the hunspell directory and loads all found dictionaries      */
DECL|method|scanAndLoadDictionaries
specifier|private
name|void
name|scanAndLoadDictionaries
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|Files
operator|.
name|isDirectory
argument_list|(
name|hunspellDir
argument_list|)
condition|)
block|{
try|try
init|(
name|DirectoryStream
argument_list|<
name|Path
argument_list|>
name|stream
init|=
name|Files
operator|.
name|newDirectoryStream
argument_list|(
name|hunspellDir
argument_list|)
init|)
block|{
for|for
control|(
name|Path
name|file
range|:
name|stream
control|)
block|{
if|if
condition|(
name|Files
operator|.
name|isDirectory
argument_list|(
name|file
argument_list|)
condition|)
block|{
try|try
init|(
name|DirectoryStream
argument_list|<
name|Path
argument_list|>
name|inner
init|=
name|Files
operator|.
name|newDirectoryStream
argument_list|(
name|hunspellDir
operator|.
name|resolve
argument_list|(
name|file
argument_list|)
argument_list|,
literal|"*.dic"
argument_list|)
init|)
block|{
if|if
condition|(
name|inner
operator|.
name|iterator
argument_list|()
operator|.
name|hasNext
argument_list|()
condition|)
block|{
comment|// just making sure it's indeed a dictionary dir
try|try
block|{
name|dictionaries
operator|.
name|getUnchecked
argument_list|(
name|file
operator|.
name|getFileName
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UncheckedExecutionException
name|e
parameter_list|)
block|{
comment|// The cache loader throws unchecked exception (see #loadDictionary()),
comment|// here we simply report the exception and continue loading the dictionaries
name|logger
operator|.
name|error
argument_list|(
literal|"exception while loading dictionary {}"
argument_list|,
name|file
operator|.
name|getFileName
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
block|}
block|}
block|}
comment|/**      * Loads the hunspell dictionary for the given local.      *      * @param locale       The locale of the hunspell dictionary to be loaded.      * @param nodeSettings The node level settings      * @param env          The node environment (from which the conf path will be resolved)      * @return The loaded Hunspell dictionary      * @throws Exception when loading fails (due to IO errors or malformed dictionary files)      */
DECL|method|loadDictionary
specifier|private
name|Dictionary
name|loadDictionary
parameter_list|(
name|String
name|locale
parameter_list|,
name|Settings
name|nodeSettings
parameter_list|,
name|Environment
name|env
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|logger
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|logger
operator|.
name|debug
argument_list|(
literal|"Loading hunspell dictionary [{}]..."
argument_list|,
name|locale
argument_list|)
expr_stmt|;
block|}
name|Path
name|dicDir
init|=
name|hunspellDir
operator|.
name|resolve
argument_list|(
name|locale
argument_list|)
decl_stmt|;
if|if
condition|(
name|FileSystemUtils
operator|.
name|isAccessibleDirectory
argument_list|(
name|dicDir
argument_list|,
name|logger
argument_list|)
operator|==
literal|false
condition|)
block|{
throw|throw
operator|new
name|ElasticsearchException
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|Locale
operator|.
name|ROOT
argument_list|,
literal|"Could not find hunspell dictionary [%s]"
argument_list|,
name|locale
argument_list|)
argument_list|)
throw|;
block|}
comment|// merging node settings with hunspell dictionary specific settings
name|nodeSettings
operator|=
name|loadDictionarySettings
argument_list|(
name|dicDir
argument_list|,
name|nodeSettings
operator|.
name|getByPrefix
argument_list|(
literal|"indices.analysis.hunspell.dictionary."
operator|+
name|locale
operator|+
literal|"."
argument_list|)
argument_list|)
expr_stmt|;
name|boolean
name|ignoreCase
init|=
name|nodeSettings
operator|.
name|getAsBoolean
argument_list|(
literal|"ignore_case"
argument_list|,
name|defaultIgnoreCase
argument_list|)
decl_stmt|;
name|Path
index|[]
name|affixFiles
init|=
name|FileSystemUtils
operator|.
name|files
argument_list|(
name|dicDir
argument_list|,
literal|"*.aff"
argument_list|)
decl_stmt|;
if|if
condition|(
name|affixFiles
operator|.
name|length
operator|==
literal|0
condition|)
block|{
throw|throw
operator|new
name|ElasticsearchException
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|Locale
operator|.
name|ROOT
argument_list|,
literal|"Missing affix file for hunspell dictionary [%s]"
argument_list|,
name|locale
argument_list|)
argument_list|)
throw|;
block|}
if|if
condition|(
name|affixFiles
operator|.
name|length
operator|!=
literal|1
condition|)
block|{
throw|throw
operator|new
name|ElasticsearchException
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|Locale
operator|.
name|ROOT
argument_list|,
literal|"Too many affix files exist for hunspell dictionary [%s]"
argument_list|,
name|locale
argument_list|)
argument_list|)
throw|;
block|}
name|InputStream
name|affixStream
init|=
literal|null
decl_stmt|;
name|Path
index|[]
name|dicFiles
init|=
name|FileSystemUtils
operator|.
name|files
argument_list|(
name|dicDir
argument_list|,
literal|"*.dic"
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|InputStream
argument_list|>
name|dicStreams
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|dicFiles
operator|.
name|length
argument_list|)
decl_stmt|;
try|try
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|dicFiles
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|dicStreams
operator|.
name|add
argument_list|(
name|Files
operator|.
name|newInputStream
argument_list|(
name|dicFiles
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|affixStream
operator|=
name|Files
operator|.
name|newInputStream
argument_list|(
name|affixFiles
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|new
name|Dictionary
argument_list|(
name|affixStream
argument_list|,
name|dicStreams
argument_list|,
name|ignoreCase
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|logger
operator|.
name|error
argument_list|(
literal|"Could not load hunspell dictionary [{}]"
argument_list|,
name|e
argument_list|,
name|locale
argument_list|)
expr_stmt|;
throw|throw
name|e
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|affixStream
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|affixStream
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
comment|// nothing much we can do here
block|}
block|}
for|for
control|(
name|InputStream
name|in
range|:
name|dicStreams
control|)
block|{
if|if
condition|(
name|in
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|in
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
comment|// nothing much we can do here
block|}
block|}
block|}
block|}
block|}
comment|/**      * Each hunspell dictionary directory may contain a {@code settings.yml} which holds dictionary specific settings. Default      * values for these settings are defined in the given default settings.      *      * @param dir      The directory of the dictionary      * @param defaults The default settings for this dictionary      * @return The resolved settings.      */
DECL|method|loadDictionarySettings
specifier|private
specifier|static
name|Settings
name|loadDictionarySettings
parameter_list|(
name|Path
name|dir
parameter_list|,
name|Settings
name|defaults
parameter_list|)
block|{
name|Path
name|file
init|=
name|dir
operator|.
name|resolve
argument_list|(
literal|"settings.yml"
argument_list|)
decl_stmt|;
if|if
condition|(
name|Files
operator|.
name|exists
argument_list|(
name|file
argument_list|)
condition|)
block|{
return|return
name|ImmutableSettings
operator|.
name|settingsBuilder
argument_list|()
operator|.
name|loadFromPath
argument_list|(
name|file
argument_list|)
operator|.
name|put
argument_list|(
name|defaults
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
name|file
operator|=
name|dir
operator|.
name|resolve
argument_list|(
literal|"settings.json"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Files
operator|.
name|exists
argument_list|(
name|file
argument_list|)
condition|)
block|{
return|return
name|ImmutableSettings
operator|.
name|settingsBuilder
argument_list|()
operator|.
name|loadFromPath
argument_list|(
name|file
argument_list|)
operator|.
name|put
argument_list|(
name|defaults
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
return|return
name|defaults
return|;
block|}
block|}
end_class

end_unit

