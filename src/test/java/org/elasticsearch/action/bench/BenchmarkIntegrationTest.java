begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to Elasticsearch under one or more contributor  * license agreements. See the NOTICE file distributed with  * this work for additional information regarding copyright  * ownership. Elasticsearch licenses this file to you under  * the Apache License, Version 2.0 (the "License"); you may  * not use this file except in compliance with the License.  * You may obtain a copy of the License at  *  *    http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing,  * software distributed under the License is distributed on an  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  * KIND, either express or implied.  See the License for the  * specific language governing permissions and limitations  * under the License.  */
end_comment

begin_package
DECL|package|org.elasticsearch.action.bench
package|package
name|org
operator|.
name|elasticsearch
operator|.
name|action
operator|.
name|bench
package|;
end_package

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Predicate
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|English
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|action
operator|.
name|ActionFuture
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|action
operator|.
name|index
operator|.
name|IndexRequestBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|action
operator|.
name|search
operator|.
name|SearchRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|Strings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|settings
operator|.
name|ImmutableSettings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|settings
operator|.
name|Settings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|index
operator|.
name|query
operator|.
name|FilterBuilders
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|index
operator|.
name|query
operator|.
name|functionscore
operator|.
name|script
operator|.
name|ScriptScoreFunctionBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|script
operator|.
name|groovy
operator|.
name|GroovyScriptEngineService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|test
operator|.
name|ElasticsearchIntegrationTest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|After
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Before
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Ignore
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|*
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|CountDownLatch
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|elasticsearch
operator|.
name|client
operator|.
name|Requests
operator|.
name|searchRequest
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|elasticsearch
operator|.
name|index
operator|.
name|query
operator|.
name|QueryBuilders
operator|.
name|functionScoreQuery
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|elasticsearch
operator|.
name|index
operator|.
name|query
operator|.
name|functionscore
operator|.
name|ScoreFunctionBuilders
operator|.
name|scriptFunction
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|elasticsearch
operator|.
name|search
operator|.
name|builder
operator|.
name|SearchSourceBuilder
operator|.
name|searchSource
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|elasticsearch
operator|.
name|test
operator|.
name|hamcrest
operator|.
name|ElasticsearchAssertions
operator|.
name|assertAcked
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|hamcrest
operator|.
name|Matchers
operator|.
name|*
import|;
end_import

begin_comment
comment|/**  * Integration tests for benchmark API  */
end_comment

begin_class
annotation|@
name|ElasticsearchIntegrationTest
operator|.
name|ClusterScope
argument_list|(
name|scope
operator|=
name|ElasticsearchIntegrationTest
operator|.
name|Scope
operator|.
name|SUITE
argument_list|)
annotation|@
name|Ignore
DECL|class|BenchmarkIntegrationTest
specifier|public
class|class
name|BenchmarkIntegrationTest
extends|extends
name|ElasticsearchIntegrationTest
block|{
DECL|field|BENCHMARK_NAME
specifier|private
specifier|static
specifier|final
name|String
name|BENCHMARK_NAME
init|=
literal|"test_benchmark"
decl_stmt|;
DECL|field|BENCHMARK_NAME_WILDCARD
specifier|private
specifier|static
specifier|final
name|String
name|BENCHMARK_NAME_WILDCARD
init|=
literal|"test_*"
decl_stmt|;
DECL|field|COMPETITOR_PREFIX
specifier|private
specifier|static
specifier|final
name|String
name|COMPETITOR_PREFIX
init|=
literal|"competitor_"
decl_stmt|;
DECL|field|INDEX_PREFIX
specifier|private
specifier|static
specifier|final
name|String
name|INDEX_PREFIX
init|=
literal|"test_index_"
decl_stmt|;
DECL|field|INDEX_TYPE
specifier|private
specifier|static
specifier|final
name|String
name|INDEX_TYPE
init|=
literal|"test_type"
decl_stmt|;
DECL|field|numExecutorNodes
specifier|private
name|int
name|numExecutorNodes
init|=
literal|0
decl_stmt|;
DECL|field|competitionSettingsMap
specifier|private
name|Map
argument_list|<
name|String
argument_list|,
name|BenchmarkSettings
argument_list|>
name|competitionSettingsMap
decl_stmt|;
DECL|field|indices
specifier|private
name|String
index|[]
name|indices
init|=
name|Strings
operator|.
name|EMPTY_ARRAY
decl_stmt|;
DECL|field|benchNodes
specifier|private
name|HashMap
argument_list|<
name|Integer
argument_list|,
name|Boolean
argument_list|>
name|benchNodes
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
annotation|@
name|Override
DECL|method|nodeSettings
specifier|protected
specifier|synchronized
name|Settings
name|nodeSettings
parameter_list|(
name|int
name|nodeOrdinal
parameter_list|)
block|{
if|if
condition|(
name|nodeOrdinal
operator|==
literal|0
condition|)
block|{
comment|// at least one
return|return
name|ImmutableSettings
operator|.
name|builder
argument_list|()
operator|.
name|put
argument_list|(
name|super
operator|.
name|nodeSettings
argument_list|(
name|nodeOrdinal
argument_list|)
argument_list|)
operator|.
name|put
argument_list|(
literal|"node.bench"
argument_list|,
literal|true
argument_list|)
operator|.
name|put
argument_list|(
name|GroovyScriptEngineService
operator|.
name|GROOVY_SCRIPT_SANDBOX_ENABLED
argument_list|,
literal|false
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
else|else
block|{
if|if
condition|(
name|benchNodes
operator|.
name|containsKey
argument_list|(
name|nodeOrdinal
argument_list|)
condition|)
block|{
return|return
name|ImmutableSettings
operator|.
name|builder
argument_list|()
operator|.
name|put
argument_list|(
name|super
operator|.
name|nodeSettings
argument_list|(
name|nodeOrdinal
argument_list|)
argument_list|)
operator|.
name|put
argument_list|(
literal|"node.bench"
argument_list|,
name|benchNodes
operator|.
name|get
argument_list|(
name|nodeOrdinal
argument_list|)
argument_list|)
operator|.
name|put
argument_list|(
name|GroovyScriptEngineService
operator|.
name|GROOVY_SCRIPT_SANDBOX_ENABLED
argument_list|,
literal|false
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
else|else
block|{
name|boolean
name|b
init|=
name|randomBoolean
argument_list|()
decl_stmt|;
name|benchNodes
operator|.
name|put
argument_list|(
name|nodeOrdinal
argument_list|,
name|b
argument_list|)
expr_stmt|;
return|return
name|ImmutableSettings
operator|.
name|builder
argument_list|()
operator|.
name|put
argument_list|(
name|super
operator|.
name|nodeSettings
argument_list|(
name|nodeOrdinal
argument_list|)
argument_list|)
operator|.
name|put
argument_list|(
literal|"node.bench"
argument_list|,
name|b
argument_list|)
operator|.
name|put
argument_list|(
name|GroovyScriptEngineService
operator|.
name|GROOVY_SCRIPT_SANDBOX_ENABLED
argument_list|,
literal|false
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
block|}
block|}
annotation|@
name|After
DECL|method|afterBenchmarkIntegrationTests
specifier|public
name|void
name|afterBenchmarkIntegrationTests
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|BenchmarkStatusResponse
name|statusResponse
init|=
name|client
argument_list|()
operator|.
name|prepareBenchStatus
argument_list|()
operator|.
name|execute
argument_list|()
operator|.
name|actionGet
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
literal|"Some benchmarks are still running"
argument_list|,
name|statusResponse
operator|.
name|benchmarkResponses
argument_list|()
argument_list|,
name|is
argument_list|(
name|empty
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Before
DECL|method|beforeBenchmarkIntegrationTests
specifier|public
name|void
name|beforeBenchmarkIntegrationTests
parameter_list|()
throws|throws
name|Exception
block|{
name|waitForTestLatch
operator|=
literal|null
expr_stmt|;
name|waitForQuery
operator|=
literal|null
expr_stmt|;
name|numExecutorNodes
operator|=
name|internalCluster
argument_list|()
operator|.
name|numBenchNodes
argument_list|()
expr_stmt|;
name|competitionSettingsMap
operator|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
expr_stmt|;
name|logger
operator|.
name|info
argument_list|(
literal|"--> indexing random data"
argument_list|)
expr_stmt|;
name|indices
operator|=
name|randomData
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testSubmitBenchmark
specifier|public
name|void
name|testSubmitBenchmark
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|int
name|iters
init|=
name|between
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|)
decl_stmt|;
comment|// we run this more than once to make sure metadata is cleaned up propperly
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|iters
condition|;
name|i
operator|++
control|)
block|{
specifier|final
name|BenchmarkRequest
name|request
init|=
name|BenchmarkTestUtil
operator|.
name|randomRequest
argument_list|(
name|client
argument_list|()
argument_list|,
name|indices
argument_list|,
name|numExecutorNodes
argument_list|,
name|competitionSettingsMap
argument_list|)
decl_stmt|;
name|logger
operator|.
name|info
argument_list|(
literal|"--> Submitting benchmark - competitors [{}] iterations [{}]"
argument_list|,
name|request
operator|.
name|competitors
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|request
operator|.
name|settings
argument_list|()
operator|.
name|iterations
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|BenchmarkResponse
name|response
init|=
name|client
argument_list|()
operator|.
name|bench
argument_list|(
name|request
argument_list|)
operator|.
name|actionGet
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|response
argument_list|,
name|notNullValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|response
operator|.
name|state
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|BenchmarkResponse
operator|.
name|State
operator|.
name|COMPLETE
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|response
operator|.
name|hasErrors
argument_list|()
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|response
operator|.
name|benchmarkName
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|BENCHMARK_NAME
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|response
operator|.
name|competitionResults
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|request
operator|.
name|competitors
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|CompetitionResult
name|result
range|:
name|response
operator|.
name|competitionResults
argument_list|()
operator|.
name|values
argument_list|()
control|)
block|{
name|assertThat
argument_list|(
name|result
operator|.
name|nodeResults
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|numExecutorNodes
argument_list|)
argument_list|)
expr_stmt|;
name|validateCompetitionResult
argument_list|(
name|result
argument_list|,
name|competitionSettingsMap
operator|.
name|get
argument_list|(
name|result
operator|.
name|competitionName
argument_list|()
argument_list|)
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
DECL|method|testListBenchmarks
specifier|public
name|void
name|testListBenchmarks
parameter_list|()
throws|throws
name|Exception
block|{
name|SearchRequest
name|searchRequest
init|=
name|prepareBlockingScriptQuery
argument_list|()
decl_stmt|;
specifier|final
name|BenchmarkRequest
name|request
init|=
name|BenchmarkTestUtil
operator|.
name|randomRequest
argument_list|(
name|client
argument_list|()
argument_list|,
name|indices
argument_list|,
name|numExecutorNodes
argument_list|,
name|competitionSettingsMap
argument_list|,
name|searchRequest
argument_list|)
decl_stmt|;
name|logger
operator|.
name|info
argument_list|(
literal|"--> Submitting benchmark - competitors [{}] iterations [{}]"
argument_list|,
name|request
operator|.
name|competitors
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|request
operator|.
name|settings
argument_list|()
operator|.
name|iterations
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|ActionFuture
argument_list|<
name|BenchmarkResponse
argument_list|>
name|future
init|=
name|client
argument_list|()
operator|.
name|bench
argument_list|(
name|request
argument_list|)
decl_stmt|;
try|try
block|{
name|waitForQuery
operator|.
name|await
argument_list|()
expr_stmt|;
specifier|final
name|BenchmarkStatusResponse
name|statusResponse
init|=
name|client
argument_list|()
operator|.
name|prepareBenchStatus
argument_list|()
operator|.
name|execute
argument_list|()
operator|.
name|actionGet
argument_list|()
decl_stmt|;
name|waitForTestLatch
operator|.
name|countDown
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|statusResponse
operator|.
name|benchmarkResponses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|equalTo
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|BenchmarkResponse
name|benchmarkResponse
range|:
name|statusResponse
operator|.
name|benchmarkResponses
argument_list|()
control|)
block|{
name|assertThat
argument_list|(
name|benchmarkResponse
operator|.
name|benchmarkName
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|BENCHMARK_NAME
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|benchmarkResponse
operator|.
name|state
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|BenchmarkResponse
operator|.
name|State
operator|.
name|RUNNING
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|benchmarkResponse
operator|.
name|hasErrors
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|CompetitionResult
name|result
range|:
name|benchmarkResponse
operator|.
name|competitionResults
argument_list|()
operator|.
name|values
argument_list|()
control|)
block|{
name|assertThat
argument_list|(
name|result
operator|.
name|nodeResults
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|lessThanOrEqualTo
argument_list|(
name|numExecutorNodes
argument_list|)
argument_list|)
expr_stmt|;
name|validateCompetitionResult
argument_list|(
name|result
argument_list|,
name|competitionSettingsMap
operator|.
name|get
argument_list|(
name|result
operator|.
name|competitionName
argument_list|()
argument_list|)
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|waitForTestLatch
operator|.
name|getCount
argument_list|()
operator|==
literal|1
condition|)
block|{
name|waitForTestLatch
operator|.
name|countDown
argument_list|()
expr_stmt|;
block|}
name|client
argument_list|()
operator|.
name|prepareAbortBench
argument_list|(
name|BENCHMARK_NAME
argument_list|)
operator|.
name|get
argument_list|()
expr_stmt|;
comment|// Confirm that there are no active benchmarks in the cluster
name|assertThat
argument_list|(
name|client
argument_list|()
operator|.
name|prepareBenchStatus
argument_list|()
operator|.
name|execute
argument_list|()
operator|.
name|actionGet
argument_list|()
operator|.
name|totalActiveBenchmarks
argument_list|()
argument_list|,
name|equalTo
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|waitForTestLatch
operator|.
name|getCount
argument_list|()
argument_list|,
name|is
argument_list|(
literal|0l
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|// Confirm that benchmark was indeed aborted
name|assertThat
argument_list|(
name|future
operator|.
name|get
argument_list|()
operator|.
name|state
argument_list|()
argument_list|,
name|isOneOf
argument_list|(
name|BenchmarkResponse
operator|.
name|State
operator|.
name|ABORTED
argument_list|,
name|BenchmarkResponse
operator|.
name|State
operator|.
name|COMPLETE
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|field|waitForTestLatch
specifier|public
specifier|static
name|CountDownLatch
name|waitForTestLatch
decl_stmt|;
DECL|field|waitForQuery
specifier|public
specifier|static
name|CountDownLatch
name|waitForQuery
decl_stmt|;
DECL|method|prepareBlockingScriptQuery
specifier|private
name|SearchRequest
name|prepareBlockingScriptQuery
parameter_list|()
block|{
comment|/* Chuck Norris back in the house!! - this is super evil but the only way at this            point to ensure we actually call abort / list while a benchmark is executing            without doing busy waiting etc. This Script calls the two static latches above and this test            will not work if somebody messes around with them but it's much faster and less resource intensive / hardware            dependent to run massive benchmarks and do busy waiting. */
name|internalCluster
argument_list|()
expr_stmt|;
comment|// mark that we need a JVM local cluster!
name|waitForQuery
operator|=
operator|new
name|CountDownLatch
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|waitForTestLatch
operator|=
operator|new
name|CountDownLatch
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|String
name|className
init|=
literal|"BenchmarkIntegrationTest"
decl_stmt|;
name|ScriptScoreFunctionBuilder
name|scriptFunction
init|=
name|scriptFunction
argument_list|(
literal|"import "
operator|+
name|this
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
operator|+
literal|"; \n"
operator|+
name|className
operator|+
literal|".waitForQuery.countDown(); \n"
operator|+
name|className
operator|+
literal|".waitForTestLatch.await(); \n return 1.0;"
argument_list|)
decl_stmt|;
name|SearchRequest
name|searchRequest
init|=
name|searchRequest
argument_list|()
operator|.
name|source
argument_list|(
name|searchSource
argument_list|()
operator|.
name|query
argument_list|(
name|functionScoreQuery
argument_list|(
name|FilterBuilders
operator|.
name|matchAllFilter
argument_list|()
argument_list|,
name|scriptFunction
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
return|return
name|searchRequest
return|;
block|}
annotation|@
name|Test
DECL|method|testBenchmarkWithErrors
specifier|public
name|void
name|testBenchmarkWithErrors
parameter_list|()
block|{
name|List
argument_list|<
name|SearchRequest
argument_list|>
name|reqList
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|int
name|numQueries
init|=
name|scaledRandomIntBetween
argument_list|(
literal|20
argument_list|,
literal|100
argument_list|)
decl_stmt|;
name|int
name|numErrors
init|=
name|scaledRandomIntBetween
argument_list|(
literal|1
argument_list|,
name|numQueries
argument_list|)
decl_stmt|;
specifier|final
name|boolean
name|containsFatal
init|=
name|randomBoolean
argument_list|()
decl_stmt|;
if|if
condition|(
name|containsFatal
condition|)
block|{
name|ScriptScoreFunctionBuilder
name|scriptFunction
init|=
name|scriptFunction
argument_list|(
literal|"DOES NOT COMPILE - fails on any shard"
argument_list|)
decl_stmt|;
name|SearchRequest
name|searchRequest
init|=
name|searchRequest
argument_list|()
operator|.
name|source
argument_list|(
name|searchSource
argument_list|()
operator|.
name|query
argument_list|(
name|functionScoreQuery
argument_list|(
name|FilterBuilders
operator|.
name|matchAllFilter
argument_list|()
argument_list|,
name|scriptFunction
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|reqList
operator|.
name|add
argument_list|(
name|searchRequest
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|reqList
operator|.
name|size
argument_list|()
operator|<
name|numErrors
condition|;
name|i
operator|++
control|)
block|{
name|ScriptScoreFunctionBuilder
name|scriptFunction
init|=
name|scriptFunction
argument_list|(
literal|"throw new RuntimeException();"
argument_list|)
decl_stmt|;
name|SearchRequest
name|searchRequest
init|=
name|searchRequest
argument_list|()
operator|.
name|source
argument_list|(
name|searchSource
argument_list|()
operator|.
name|query
argument_list|(
name|functionScoreQuery
argument_list|(
name|FilterBuilders
operator|.
name|matchAllFilter
argument_list|()
argument_list|,
name|scriptFunction
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|reqList
operator|.
name|add
argument_list|(
name|searchRequest
argument_list|)
expr_stmt|;
block|}
name|logger
operator|.
name|info
argument_list|(
literal|"--> run with [{}] errors "
argument_list|,
name|numErrors
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|reqList
operator|.
name|size
argument_list|()
operator|<
name|numQueries
condition|;
name|i
operator|++
control|)
block|{
name|reqList
operator|.
name|add
argument_list|(
name|BenchmarkTestUtil
operator|.
name|randomSearch
argument_list|(
name|client
argument_list|()
argument_list|,
name|indices
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|Collections
operator|.
name|shuffle
argument_list|(
name|reqList
argument_list|,
name|getRandom
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|BenchmarkRequest
name|request
init|=
name|BenchmarkTestUtil
operator|.
name|randomRequest
argument_list|(
name|client
argument_list|()
argument_list|,
name|indices
argument_list|,
name|numExecutorNodes
argument_list|,
name|competitionSettingsMap
argument_list|,
name|reqList
operator|.
name|toArray
argument_list|(
operator|new
name|SearchRequest
index|[
literal|0
index|]
argument_list|)
argument_list|)
decl_stmt|;
name|logger
operator|.
name|info
argument_list|(
literal|"--> Submitting benchmark - competitors [{}] iterations [{}]"
argument_list|,
name|request
operator|.
name|competitors
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|request
operator|.
name|settings
argument_list|()
operator|.
name|iterations
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|BenchmarkResponse
name|response
init|=
name|client
argument_list|()
operator|.
name|bench
argument_list|(
name|request
argument_list|)
operator|.
name|actionGet
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|response
argument_list|,
name|notNullValue
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|response
operator|.
name|hasErrors
argument_list|()
operator|||
name|containsFatal
condition|)
block|{
name|assertThat
argument_list|(
name|response
operator|.
name|state
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|BenchmarkResponse
operator|.
name|State
operator|.
name|FAILED
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|assertThat
argument_list|(
name|response
operator|.
name|state
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|BenchmarkResponse
operator|.
name|State
operator|.
name|COMPLETE
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|CompetitionResult
name|result
range|:
name|response
operator|.
name|competitionResults
argument_list|()
operator|.
name|values
argument_list|()
control|)
block|{
name|assertThat
argument_list|(
name|result
operator|.
name|nodeResults
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|numExecutorNodes
argument_list|)
argument_list|)
expr_stmt|;
name|validateCompetitionResult
argument_list|(
name|result
argument_list|,
name|competitionSettingsMap
operator|.
name|get
argument_list|(
name|result
operator|.
name|competitionName
argument_list|()
argument_list|)
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
block|}
name|assertThat
argument_list|(
name|response
operator|.
name|benchmarkName
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|BENCHMARK_NAME
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testAbortByPattern
specifier|public
name|void
name|testAbortByPattern
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|int
name|iters
init|=
name|between
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|)
decl_stmt|;
comment|// we run this more than once to make sure metadata is cleaned up propperly
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|iters
condition|;
name|i
operator|++
control|)
block|{
name|List
argument_list|<
name|BenchmarkRequest
argument_list|>
name|requests
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|ActionFuture
argument_list|<
name|BenchmarkResponse
argument_list|>
argument_list|>
name|responses
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|SearchRequest
name|searchRequest
init|=
name|prepareBlockingScriptQuery
argument_list|()
decl_stmt|;
specifier|final
name|int
name|benches
init|=
name|between
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|)
decl_stmt|;
name|String
index|[]
name|names
init|=
operator|new
name|String
index|[
name|benches
index|]
decl_stmt|;
for|for
control|(
name|int
name|k
init|=
literal|0
init|;
name|k
operator|<
name|benches
condition|;
name|k
operator|++
control|)
block|{
specifier|final
name|BenchmarkRequest
name|request
init|=
name|BenchmarkTestUtil
operator|.
name|randomRequest
argument_list|(
name|client
argument_list|()
argument_list|,
name|indices
argument_list|,
name|numExecutorNodes
argument_list|,
name|competitionSettingsMap
argument_list|,
name|searchRequest
argument_list|)
decl_stmt|;
name|request
operator|.
name|settings
argument_list|()
operator|.
name|iterations
argument_list|(
name|Integer
operator|.
name|MAX_VALUE
argument_list|,
literal|true
argument_list|)
expr_stmt|;
comment|// massive amount of iterations
name|names
index|[
name|k
index|]
operator|=
name|BENCHMARK_NAME
operator|+
name|Integer
operator|.
name|toString
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|request
operator|.
name|benchmarkName
argument_list|(
name|names
index|[
name|k
index|]
argument_list|)
expr_stmt|;
name|requests
operator|.
name|add
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|logger
operator|.
name|info
argument_list|(
literal|"--> Submitting benchmark - competitors [{}] iterations [{}]"
argument_list|,
name|request
operator|.
name|competitors
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|request
operator|.
name|settings
argument_list|()
operator|.
name|iterations
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|boolean
name|aborted
init|=
literal|false
decl_stmt|;
for|for
control|(
name|BenchmarkRequest
name|r
range|:
name|requests
control|)
block|{
specifier|final
name|ActionFuture
argument_list|<
name|BenchmarkResponse
argument_list|>
name|benchmarkResponse
init|=
name|client
argument_list|()
operator|.
name|bench
argument_list|(
name|r
argument_list|)
decl_stmt|;
name|responses
operator|.
name|add
argument_list|(
name|benchmarkResponse
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|waitForQuery
operator|.
name|await
argument_list|()
expr_stmt|;
if|if
condition|(
name|benches
operator|>
literal|1
condition|)
block|{
name|awaitBusy
argument_list|(
operator|new
name|Predicate
argument_list|<
name|Object
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|boolean
name|apply
parameter_list|(
name|java
operator|.
name|lang
operator|.
name|Object
name|input
parameter_list|)
block|{
return|return
name|client
argument_list|()
operator|.
name|prepareBenchStatus
argument_list|()
operator|.
name|get
argument_list|()
operator|.
name|benchmarkResponses
argument_list|()
operator|.
name|size
argument_list|()
operator|==
name|benches
return|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
specifier|final
name|String
name|badPatternA
init|=
literal|"*z"
decl_stmt|;
specifier|final
name|String
name|badPatternB
init|=
literal|"xxx"
decl_stmt|;
specifier|final
name|String
index|[]
name|patterns
decl_stmt|;
switch|switch
condition|(
name|getRandom
argument_list|()
operator|.
name|nextInt
argument_list|(
literal|3
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|patterns
operator|=
operator|new
name|String
index|[]
block|{
literal|"*"
block|}
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|patterns
operator|=
operator|new
name|String
index|[]
block|{
name|BENCHMARK_NAME_WILDCARD
block|,
name|badPatternA
block|,
name|badPatternB
block|}
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|patterns
operator|=
name|names
expr_stmt|;
break|break;
default|default:
name|patterns
operator|=
operator|new
name|String
index|[]
block|{
name|BENCHMARK_NAME_WILDCARD
block|}
expr_stmt|;
block|}
specifier|final
name|AbortBenchmarkResponse
name|abortResponse
init|=
name|client
argument_list|()
operator|.
name|prepareAbortBench
argument_list|(
name|patterns
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|aborted
operator|=
literal|true
expr_stmt|;
name|assertAcked
argument_list|(
name|abortResponse
argument_list|)
expr_stmt|;
comment|// Confirm that there are no active benchmarks in the cluster
specifier|final
name|BenchmarkStatusResponse
name|statusResponse
init|=
name|client
argument_list|()
operator|.
name|prepareBenchStatus
argument_list|()
operator|.
name|execute
argument_list|()
operator|.
name|actionGet
argument_list|()
decl_stmt|;
name|waitForTestLatch
operator|.
name|countDown
argument_list|()
expr_stmt|;
comment|// let the queries go - we already aborted and got the status
name|assertThat
argument_list|(
name|statusResponse
operator|.
name|totalActiveBenchmarks
argument_list|()
argument_list|,
name|equalTo
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|// Confirm that benchmark was indeed aborted
for|for
control|(
name|ActionFuture
argument_list|<
name|BenchmarkResponse
argument_list|>
name|r
range|:
name|responses
control|)
block|{
name|assertThat
argument_list|(
name|r
operator|.
name|get
argument_list|()
operator|.
name|state
argument_list|()
argument_list|,
name|is
argument_list|(
name|BenchmarkResponse
operator|.
name|State
operator|.
name|ABORTED
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|waitForTestLatch
operator|.
name|getCount
argument_list|()
operator|==
literal|1
condition|)
block|{
name|waitForTestLatch
operator|.
name|countDown
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|aborted
condition|)
block|{
name|client
argument_list|()
operator|.
name|prepareAbortBench
argument_list|(
name|BENCHMARK_NAME
argument_list|)
operator|.
name|get
argument_list|()
expr_stmt|;
block|}
name|assertThat
argument_list|(
name|waitForTestLatch
operator|.
name|getCount
argument_list|()
argument_list|,
name|is
argument_list|(
literal|0l
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
DECL|method|testAbortBenchmark
specifier|public
name|void
name|testAbortBenchmark
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|int
name|iters
init|=
name|between
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|)
decl_stmt|;
comment|// we run this more than once to make sure metadata is cleaned up propperly
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|iters
condition|;
name|i
operator|++
control|)
block|{
name|SearchRequest
name|searchRequest
init|=
name|prepareBlockingScriptQuery
argument_list|()
decl_stmt|;
specifier|final
name|BenchmarkRequest
name|request
init|=
name|BenchmarkTestUtil
operator|.
name|randomRequest
argument_list|(
name|client
argument_list|()
argument_list|,
name|indices
argument_list|,
name|numExecutorNodes
argument_list|,
name|competitionSettingsMap
argument_list|,
name|searchRequest
argument_list|)
decl_stmt|;
name|request
operator|.
name|settings
argument_list|()
operator|.
name|iterations
argument_list|(
name|Integer
operator|.
name|MAX_VALUE
argument_list|,
literal|true
argument_list|)
expr_stmt|;
comment|// massive amount of iterations
name|logger
operator|.
name|info
argument_list|(
literal|"--> Submitting benchmark - competitors [{}] iterations [{}]"
argument_list|,
name|request
operator|.
name|competitors
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|request
operator|.
name|settings
argument_list|()
operator|.
name|iterations
argument_list|()
argument_list|)
expr_stmt|;
name|boolean
name|aborted
init|=
literal|false
decl_stmt|;
specifier|final
name|ActionFuture
argument_list|<
name|BenchmarkResponse
argument_list|>
name|benchmarkResponse
init|=
name|client
argument_list|()
operator|.
name|bench
argument_list|(
name|request
argument_list|)
decl_stmt|;
try|try
block|{
name|waitForQuery
operator|.
name|await
argument_list|()
expr_stmt|;
specifier|final
name|AbortBenchmarkResponse
name|abortResponse
init|=
name|client
argument_list|()
operator|.
name|prepareAbortBench
argument_list|(
name|BENCHMARK_NAME
argument_list|)
operator|.
name|get
argument_list|()
decl_stmt|;
name|aborted
operator|=
literal|true
expr_stmt|;
comment|// Confirm that the benchmark was actually aborted and did not finish on its own
name|assertAcked
argument_list|(
name|abortResponse
argument_list|)
expr_stmt|;
comment|// Confirm that there are no active benchmarks in the cluster
specifier|final
name|BenchmarkStatusResponse
name|statusResponse
init|=
name|client
argument_list|()
operator|.
name|prepareBenchStatus
argument_list|()
operator|.
name|execute
argument_list|()
operator|.
name|actionGet
argument_list|()
decl_stmt|;
name|waitForTestLatch
operator|.
name|countDown
argument_list|()
expr_stmt|;
comment|// let the queries go - we already aborted and got the status
name|assertThat
argument_list|(
name|statusResponse
operator|.
name|totalActiveBenchmarks
argument_list|()
argument_list|,
name|equalTo
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|// Confirm that benchmark was indeed aborted
name|assertThat
argument_list|(
name|benchmarkResponse
operator|.
name|get
argument_list|()
operator|.
name|state
argument_list|()
argument_list|,
name|is
argument_list|(
name|BenchmarkResponse
operator|.
name|State
operator|.
name|ABORTED
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|waitForTestLatch
operator|.
name|getCount
argument_list|()
operator|==
literal|1
condition|)
block|{
name|waitForTestLatch
operator|.
name|countDown
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|aborted
condition|)
block|{
name|client
argument_list|()
operator|.
name|prepareAbortBench
argument_list|(
name|BENCHMARK_NAME
argument_list|)
operator|.
name|get
argument_list|()
expr_stmt|;
block|}
name|assertThat
argument_list|(
name|waitForTestLatch
operator|.
name|getCount
argument_list|()
argument_list|,
name|is
argument_list|(
literal|0l
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
argument_list|(
name|expected
operator|=
name|BenchmarkMissingException
operator|.
name|class
argument_list|)
DECL|method|testAbortNoSuchBenchmark
specifier|public
name|void
name|testAbortNoSuchBenchmark
parameter_list|()
throws|throws
name|Exception
block|{
name|client
argument_list|()
operator|.
name|prepareAbortBench
argument_list|(
name|BENCHMARK_NAME
argument_list|)
operator|.
name|execute
argument_list|()
operator|.
name|actionGet
argument_list|()
expr_stmt|;
block|}
DECL|method|validateCompetitionResult
specifier|private
name|void
name|validateCompetitionResult
parameter_list|(
name|CompetitionResult
name|result
parameter_list|,
name|BenchmarkSettings
name|requestedSettings
parameter_list|,
name|boolean
name|strict
parameter_list|)
block|{
comment|// Validate settings
name|assertTrue
argument_list|(
name|result
operator|.
name|competitionName
argument_list|()
operator|.
name|startsWith
argument_list|(
name|COMPETITOR_PREFIX
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|result
operator|.
name|concurrency
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|requestedSettings
operator|.
name|concurrency
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|result
operator|.
name|multiplier
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|requestedSettings
operator|.
name|multiplier
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
comment|// Validate node-level responses
for|for
control|(
name|CompetitionNodeResult
name|nodeResult
range|:
name|result
operator|.
name|nodeResults
argument_list|()
control|)
block|{
name|assertThat
argument_list|(
name|nodeResult
operator|.
name|nodeName
argument_list|()
argument_list|,
name|notNullValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|nodeResult
operator|.
name|totalIterations
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|requestedSettings
operator|.
name|iterations
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strict
condition|)
block|{
name|assertThat
argument_list|(
name|nodeResult
operator|.
name|completedIterations
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|requestedSettings
operator|.
name|iterations
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
specifier|final
name|int
name|expectedQueryCount
init|=
name|requestedSettings
operator|.
name|multiplier
argument_list|()
operator|*
name|nodeResult
operator|.
name|totalIterations
argument_list|()
operator|*
name|requestedSettings
operator|.
name|searchRequests
argument_list|()
operator|.
name|size
argument_list|()
decl_stmt|;
name|assertThat
argument_list|(
name|nodeResult
operator|.
name|totalExecutedQueries
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|expectedQueryCount
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|nodeResult
operator|.
name|iterations
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|requestedSettings
operator|.
name|iterations
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|assertThat
argument_list|(
name|nodeResult
operator|.
name|warmUpTime
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
literal|0L
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|CompetitionIteration
name|iteration
range|:
name|nodeResult
operator|.
name|iterations
argument_list|()
control|)
block|{
comment|// Basic sanity checks
name|iteration
operator|.
name|computeStatistics
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|iteration
operator|.
name|totalTime
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
literal|0L
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|iteration
operator|.
name|min
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
literal|0L
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|iteration
operator|.
name|max
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
name|iteration
operator|.
name|min
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|iteration
operator|.
name|mean
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
operator|(
name|double
operator|)
name|iteration
operator|.
name|min
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|iteration
operator|.
name|mean
argument_list|()
argument_list|,
name|lessThanOrEqualTo
argument_list|(
operator|(
name|double
operator|)
name|iteration
operator|.
name|max
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|iteration
operator|.
name|queriesPerSecond
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
literal|0.0
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|iteration
operator|.
name|millisPerHit
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
literal|0.0
argument_list|)
argument_list|)
expr_stmt|;
name|validatePercentiles
argument_list|(
name|iteration
operator|.
name|percentileValues
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Validate summary statistics
specifier|final
name|CompetitionSummary
name|summary
init|=
name|result
operator|.
name|competitionSummary
argument_list|()
decl_stmt|;
name|summary
operator|.
name|computeSummaryStatistics
argument_list|()
expr_stmt|;
name|assertThat
argument_list|(
name|summary
argument_list|,
name|notNullValue
argument_list|()
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|summary
operator|.
name|getMin
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
literal|0L
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|summary
operator|.
name|getMax
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
name|summary
operator|.
name|getMin
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|summary
operator|.
name|getMean
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
operator|(
name|double
operator|)
name|summary
operator|.
name|getMin
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|summary
operator|.
name|getMean
argument_list|()
argument_list|,
name|lessThanOrEqualTo
argument_list|(
operator|(
name|double
operator|)
name|summary
operator|.
name|getMax
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|summary
operator|.
name|getTotalTime
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
literal|0L
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|summary
operator|.
name|getQueriesPerSecond
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
literal|0.0
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|summary
operator|.
name|getMillisPerHit
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
literal|0.0
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|summary
operator|.
name|getAvgWarmupTime
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
literal|0.0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strict
condition|)
block|{
name|assertThat
argument_list|(
operator|(
name|int
operator|)
name|summary
operator|.
name|getTotalIterations
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|requestedSettings
operator|.
name|iterations
argument_list|()
operator|*
name|summary
operator|.
name|nodeResults
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
operator|(
name|int
operator|)
name|summary
operator|.
name|getCompletedIterations
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|requestedSettings
operator|.
name|iterations
argument_list|()
operator|*
name|summary
operator|.
name|nodeResults
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
operator|(
name|int
operator|)
name|summary
operator|.
name|getTotalQueries
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|requestedSettings
operator|.
name|iterations
argument_list|()
operator|*
name|requestedSettings
operator|.
name|multiplier
argument_list|()
operator|*
name|requestedSettings
operator|.
name|searchRequests
argument_list|()
operator|.
name|size
argument_list|()
operator|*
name|summary
operator|.
name|nodeResults
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|validatePercentiles
argument_list|(
name|summary
operator|.
name|percentileValues
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|validatePercentiles
specifier|private
name|void
name|validatePercentiles
parameter_list|(
name|Map
argument_list|<
name|Double
argument_list|,
name|Double
argument_list|>
name|percentiles
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|double
name|last
init|=
name|Double
operator|.
name|NEGATIVE_INFINITY
decl_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|Double
argument_list|,
name|Double
argument_list|>
name|entry
range|:
name|percentiles
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|assertThat
argument_list|(
name|entry
operator|.
name|getKey
argument_list|()
argument_list|,
name|equalTo
argument_list|(
name|BenchmarkSettings
operator|.
name|DEFAULT_PERCENTILES
index|[
name|i
operator|++
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|// This is a hedge against rounding errors. Sometimes two adjacent percentile values will
comment|// be nearly equivalent except for some insignificant decimal places. In such cases we
comment|// want the two values to compare as equal.
name|assertThat
argument_list|(
name|entry
operator|.
name|getValue
argument_list|()
argument_list|,
name|greaterThanOrEqualTo
argument_list|(
name|last
operator|-
literal|1e-6
argument_list|)
argument_list|)
expr_stmt|;
name|last
operator|=
name|entry
operator|.
name|getValue
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|randomData
specifier|private
name|String
index|[]
name|randomData
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|int
name|numIndices
init|=
name|scaledRandomIntBetween
argument_list|(
literal|1
argument_list|,
literal|5
argument_list|)
decl_stmt|;
specifier|final
name|String
index|[]
name|indices
init|=
operator|new
name|String
index|[
name|numIndices
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|numIndices
condition|;
name|i
operator|++
control|)
block|{
name|indices
index|[
name|i
index|]
operator|=
name|INDEX_PREFIX
operator|+
name|i
expr_stmt|;
specifier|final
name|int
name|numDocs
init|=
name|scaledRandomIntBetween
argument_list|(
literal|1
argument_list|,
literal|100
argument_list|)
decl_stmt|;
specifier|final
name|IndexRequestBuilder
index|[]
name|docs
init|=
operator|new
name|IndexRequestBuilder
index|[
name|numDocs
index|]
decl_stmt|;
for|for
control|(
name|int
name|j
init|=
literal|0
init|;
name|j
operator|<
name|numDocs
condition|;
name|j
operator|++
control|)
block|{
name|docs
index|[
name|j
index|]
operator|=
name|client
argument_list|()
operator|.
name|prepareIndex
argument_list|(
name|indices
index|[
name|i
index|]
argument_list|,
name|INDEX_TYPE
argument_list|)
operator|.
name|setSource
argument_list|(
name|BenchmarkTestUtil
operator|.
name|TestIndexField
operator|.
name|INT_FIELD
operator|.
name|toString
argument_list|()
argument_list|,
name|randomInt
argument_list|()
argument_list|,
name|BenchmarkTestUtil
operator|.
name|TestIndexField
operator|.
name|FLOAT_FIELD
operator|.
name|toString
argument_list|()
argument_list|,
name|randomFloat
argument_list|()
argument_list|,
name|BenchmarkTestUtil
operator|.
name|TestIndexField
operator|.
name|BOOLEAN_FIELD
operator|.
name|toString
argument_list|()
argument_list|,
name|randomBoolean
argument_list|()
argument_list|,
name|BenchmarkTestUtil
operator|.
name|TestIndexField
operator|.
name|STRING_FIELD
operator|.
name|toString
argument_list|()
argument_list|,
name|English
operator|.
name|intToEnglish
argument_list|(
name|j
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|indexRandom
argument_list|(
literal|true
argument_list|,
name|docs
argument_list|)
expr_stmt|;
block|}
name|flushAndRefresh
argument_list|()
expr_stmt|;
return|return
name|indices
return|;
block|}
block|}
end_class

end_unit

