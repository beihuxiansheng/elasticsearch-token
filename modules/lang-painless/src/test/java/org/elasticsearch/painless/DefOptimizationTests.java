begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to Elasticsearch under one or more contributor  * license agreements. See the NOTICE file distributed with  * this work for additional information regarding copyright  * ownership. Elasticsearch licenses this file to you under  * the Apache License, Version 2.0 (the "License"); you may  * not use this file except in compliance with the License.  * You may obtain a copy of the License at  *  *    http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing,  * software distributed under the License is distributed on an  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  * KIND, either express or implied.  See the License for the  * specific language governing permissions and limitations  * under the License.  */
end_comment

begin_package
DECL|package|org.elasticsearch.painless
package|package
name|org
operator|.
name|elasticsearch
operator|.
name|painless
package|;
end_package

begin_class
DECL|class|DefOptimizationTests
specifier|public
class|class
name|DefOptimizationTests
extends|extends
name|ScriptTestCase
block|{
DECL|method|testIntBraceArrayOptiLoad
specifier|public
name|void
name|testIntBraceArrayOptiLoad
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x = 0; def y = new int[1]; y[0] = 5; x = y[0]; return x;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC arrayLoad(Ljava/lang/Object;I)I"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|5
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testIntBraceArrayOptiStore
specifier|public
name|void
name|testIntBraceArrayOptiStore
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x = 1; def y = new int[1]; y[0] = x; return y[0];"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC arrayStore(Ljava/lang/Object;II)"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testIntBraceListOptiLoad
specifier|public
name|void
name|testIntBraceListOptiLoad
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x = 0; def y = new ArrayList(); y.add(5); x = y[0]; return x;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC arrayLoad(Ljava/lang/Object;I)I"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|5
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testIntBraceListOptiStore
specifier|public
name|void
name|testIntBraceListOptiStore
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x = 1; def y = new ArrayList(); y.add(0); y[0] = x; return y[0];"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC arrayStore(Ljava/lang/Object;II)"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testIntBraceMapOptiLoad
specifier|public
name|void
name|testIntBraceMapOptiLoad
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x = 0; def y = new HashMap(); y.put(0, 5); x = y[0];"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC arrayLoad(Ljava/lang/Object;I)I"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|5
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testIntBraceMapOptiStore
specifier|public
name|void
name|testIntBraceMapOptiStore
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x = 1; def y = new HashMap(); y.put(0, 1); y[0] = x;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC arrayStore(Ljava/lang/Object;II)"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testIntFieldListOptiLoad
specifier|public
name|void
name|testIntFieldListOptiLoad
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x = 0; def y = new ArrayList(); y.add(5); x = y.0;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC 0(Ljava/lang/Object;)I"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|5
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testIntFieldListOptiStore
specifier|public
name|void
name|testIntFieldListOptiStore
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x = 1; def y = new ArrayList(); y.add(0); y.0 = x;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC 0(Ljava/lang/Object;I)"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testIntFieldMapOptiLoad
specifier|public
name|void
name|testIntFieldMapOptiLoad
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x = 0; def y = new HashMap(); y.put('0', 5); x = y.0; return x;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC 0(Ljava/lang/Object;)I"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|5
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testIntFieldMapOptiStore
specifier|public
name|void
name|testIntFieldMapOptiStore
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x = 1; def y = new HashMap(); y.put('0', 1); y.0 = x; return y.0;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC 0(Ljava/lang/Object;I)"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testIntCall0Opti
specifier|public
name|void
name|testIntCall0Opti
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x; def y = new HashMap(); y['int'] = 1; x = y.get('int'); return x;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC get(Ljava/lang/Object;Ljava/lang/String;)I"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testIntCall1Opti
specifier|public
name|void
name|testIntCall1Opti
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x; def y = new HashMap(); y['int'] = 1; x = y.get('int');"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC get(Ljava/lang/Object;Ljava/lang/String;)I"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testDoubleBraceArrayOptiLoad
specifier|public
name|void
name|testDoubleBraceArrayOptiLoad
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"double x = 0; def y = new double[1]; y[0] = 5.0; x = y[0]; return x;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC arrayLoad(Ljava/lang/Object;I)D"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|5.0
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testDoubleBraceArrayOptiStore
specifier|public
name|void
name|testDoubleBraceArrayOptiStore
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"double x = 1; def y = new double[1]; y[0] = x; return y[0];"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC arrayStore(Ljava/lang/Object;ID)"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1.0
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testDoubleBraceListOptiLoad
specifier|public
name|void
name|testDoubleBraceListOptiLoad
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"double x = 0.0; def y = new ArrayList(); y.add(5.0); x = y[0]; return x;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC arrayLoad(Ljava/lang/Object;I)D"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|5.0
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testDoubleBraceListOptiStore
specifier|public
name|void
name|testDoubleBraceListOptiStore
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"double x = 1.0; def y = new ArrayList(); y.add(0.0); y[0] = x; return y[0];"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC arrayStore(Ljava/lang/Object;ID)"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1.0
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testDoubleBraceMapOptiLoad
specifier|public
name|void
name|testDoubleBraceMapOptiLoad
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"double x = 0.0; def y = new HashMap(); y.put(0, 5.0); x = y[0];"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC arrayLoad(Ljava/lang/Object;I)D"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|5.0
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testDoubleBraceMapOptiStore
specifier|public
name|void
name|testDoubleBraceMapOptiStore
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"double x = 1.0; def y = new HashMap(); y.put(0, 2.0); y[0] = x;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC arrayStore(Ljava/lang/Object;ID)"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1.0
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testDoubleFieldListOptiLoad
specifier|public
name|void
name|testDoubleFieldListOptiLoad
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"double x = 0; def y = new ArrayList(); y.add(5.0); x = y.0;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC 0(Ljava/lang/Object;)D"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|5.0
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testDoubleFieldListOptiStore
specifier|public
name|void
name|testDoubleFieldListOptiStore
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"double x = 1.0; def y = new ArrayList(); y.add(0); y.0 = x;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC 0(Ljava/lang/Object;D)"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1.0
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testDoubleFieldMapOptiLoad
specifier|public
name|void
name|testDoubleFieldMapOptiLoad
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"double x = 0; def y = new HashMap(); y.put('0', 5.0); x = y.0; return x;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC 0(Ljava/lang/Object;)D"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|5.0
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testDoubleFieldMapOptiStore
specifier|public
name|void
name|testDoubleFieldMapOptiStore
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"double x = 1.0; def y = new HashMap(); y.put('0', 1.0); y.0 = x; return y.0;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC 0(Ljava/lang/Object;D)"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1.0
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testDoubleCall0Opti
specifier|public
name|void
name|testDoubleCall0Opti
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"double x; def y = new HashMap(); y['double'] = 1.0; x = y.get('double'); return x;"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC get(Ljava/lang/Object;Ljava/lang/String;)D"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1.0
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testDoubleCall1Opti
specifier|public
name|void
name|testDoubleCall1Opti
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"double x; def y = new HashMap(); y['double'] = 1.0; x = y.get('double');"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC get(Ljava/lang/Object;Ljava/lang/String;)D"
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|1.0
argument_list|,
name|exec
argument_list|(
name|script
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testIllegalCast
specifier|public
name|void
name|testIllegalCast
parameter_list|()
block|{
specifier|final
name|String
name|script
init|=
literal|"int x;\ndef y = new HashMap();\ny['double'] = 1.0;\nx = y.get('double');\n"
decl_stmt|;
name|assertBytecodeExists
argument_list|(
name|script
argument_list|,
literal|"INVOKEDYNAMIC get(Ljava/lang/Object;Ljava/lang/String;)I"
argument_list|)
expr_stmt|;
specifier|final
name|Exception
name|exception
init|=
name|expectThrows
argument_list|(
name|ClassCastException
operator|.
name|class
argument_list|,
parameter_list|()
lambda|->
block|{
name|exec
argument_list|(
name|script
argument_list|)
expr_stmt|;
block|}
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|exception
operator|.
name|getMessage
argument_list|()
operator|.
name|contains
argument_list|(
literal|"Cannot cast java.lang.Double to java.lang.Integer"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

