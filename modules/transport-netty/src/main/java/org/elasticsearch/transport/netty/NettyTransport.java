begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to Elasticsearch under one or more contributor  * license agreements. See the NOTICE file distributed with  * this work for additional information regarding copyright  * ownership. Elasticsearch licenses this file to you under  * the Apache License, Version 2.0 (the "License"); you may  * not use this file except in compliance with the License.  * You may obtain a copy of the License at  *  *    http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing,  * software distributed under the License is distributed on an  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  * KIND, either express or implied.  See the License for the  * specific language governing permissions and limitations  * under the License.  */
end_comment

begin_package
DECL|package|org.elasticsearch.transport.netty
package|package
name|org
operator|.
name|elasticsearch
operator|.
name|transport
operator|.
name|netty
package|;
end_package

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|ElasticsearchException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|cluster
operator|.
name|node
operator|.
name|DiscoveryNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|Booleans
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|bytes
operator|.
name|BytesReference
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|inject
operator|.
name|Inject
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|io
operator|.
name|stream
operator|.
name|NamedWriteableRegistry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|lease
operator|.
name|Releasables
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|network
operator|.
name|NetworkService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|network
operator|.
name|NetworkService
operator|.
name|TcpSettings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|network
operator|.
name|NetworkUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|settings
operator|.
name|Setting
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|settings
operator|.
name|Setting
operator|.
name|Property
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|settings
operator|.
name|Settings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|transport
operator|.
name|InetSocketTransportAddress
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|unit
operator|.
name|ByteSizeValue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|util
operator|.
name|BigArrays
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|util
operator|.
name|concurrent
operator|.
name|EsExecutors
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|indices
operator|.
name|breaker
operator|.
name|CircuitBreakerService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|monitor
operator|.
name|jvm
operator|.
name|JvmInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|threadpool
operator|.
name|ThreadPool
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|transport
operator|.
name|ConnectTransportException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|transport
operator|.
name|TcpTransport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|transport
operator|.
name|TransportServiceAdapter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|transport
operator|.
name|TransportSettings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|bootstrap
operator|.
name|ClientBootstrap
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|bootstrap
operator|.
name|ServerBootstrap
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|AdaptiveReceiveBufferSizePredictorFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|Channel
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelFuture
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelFutureListener
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelHandlerContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelPipeline
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ChannelPipelineFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|Channels
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ExceptionEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|FixedReceiveBufferSizePredictorFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|ReceiveBufferSizePredictorFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|socket
operator|.
name|nio
operator|.
name|NioClientSocketChannelFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|socket
operator|.
name|nio
operator|.
name|NioServerSocketChannelFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|socket
operator|.
name|nio
operator|.
name|NioWorkerPool
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|socket
operator|.
name|oio
operator|.
name|OioClientSocketChannelFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|channel
operator|.
name|socket
operator|.
name|oio
operator|.
name|OioServerSocketChannelFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jboss
operator|.
name|netty
operator|.
name|util
operator|.
name|HashedWheelTimer
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|InetSocketAddress
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|AccessController
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|PrivilegedAction
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Executors
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ThreadFactory
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|settings
operator|.
name|Setting
operator|.
name|byteSizeSetting
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|settings
operator|.
name|Setting
operator|.
name|intSetting
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ConcurrentCollections
operator|.
name|newConcurrentMap
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|util
operator|.
name|concurrent
operator|.
name|EsExecutors
operator|.
name|daemonThreadFactory
import|;
end_import

begin_comment
comment|/**  * There are 4 types of connections per node, low/med/high/ping. Low if for batch oriented APIs (like recovery or  * batch) with high payload that will cause regular request. (like search or single index) to take  * longer. Med is for the typical search / single doc index. And High for things like cluster state. Ping is reserved for  * sending out ping requests to other nodes.  */
end_comment

begin_class
DECL|class|NettyTransport
specifier|public
class|class
name|NettyTransport
extends|extends
name|TcpTransport
argument_list|<
name|Channel
argument_list|>
block|{
static|static
block|{
name|NettyUtils
operator|.
name|setup
argument_list|()
expr_stmt|;
block|}
DECL|field|WORKER_COUNT
specifier|public
specifier|static
specifier|final
name|Setting
argument_list|<
name|Integer
argument_list|>
name|WORKER_COUNT
init|=
operator|new
name|Setting
argument_list|<>
argument_list|(
literal|"transport.netty.worker_count"
argument_list|,
parameter_list|(
name|s
parameter_list|)
lambda|->
name|Integer
operator|.
name|toString
argument_list|(
name|EsExecutors
operator|.
name|boundedNumberOfProcessors
argument_list|(
name|s
argument_list|)
operator|*
literal|2
argument_list|)
argument_list|,
parameter_list|(
name|s
parameter_list|)
lambda|->
name|Setting
operator|.
name|parseInt
argument_list|(
name|s
argument_list|,
literal|1
argument_list|,
literal|"transport.netty.worker_count"
argument_list|)
argument_list|,
name|Property
operator|.
name|NodeScope
argument_list|)
decl_stmt|;
DECL|field|NETTY_MAX_CUMULATION_BUFFER_CAPACITY
specifier|public
specifier|static
specifier|final
name|Setting
argument_list|<
name|ByteSizeValue
argument_list|>
name|NETTY_MAX_CUMULATION_BUFFER_CAPACITY
init|=
name|Setting
operator|.
name|byteSizeSetting
argument_list|(
literal|"transport.netty.max_cumulation_buffer_capacity"
argument_list|,
operator|new
name|ByteSizeValue
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|,
name|Property
operator|.
name|NodeScope
argument_list|)
decl_stmt|;
DECL|field|NETTY_MAX_COMPOSITE_BUFFER_COMPONENTS
specifier|public
specifier|static
specifier|final
name|Setting
argument_list|<
name|Integer
argument_list|>
name|NETTY_MAX_COMPOSITE_BUFFER_COMPONENTS
init|=
name|Setting
operator|.
name|intSetting
argument_list|(
literal|"transport.netty.max_composite_buffer_components"
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
name|Property
operator|.
name|NodeScope
argument_list|)
decl_stmt|;
comment|// See AdaptiveReceiveBufferSizePredictor#DEFAULT_XXX for default values in netty..., we can use higher ones for us, even fixed one
DECL|field|NETTY_RECEIVE_PREDICTOR_SIZE
specifier|public
specifier|static
specifier|final
name|Setting
argument_list|<
name|ByteSizeValue
argument_list|>
name|NETTY_RECEIVE_PREDICTOR_SIZE
init|=
name|Setting
operator|.
name|byteSizeSetting
argument_list|(
literal|"transport.netty.receive_predictor_size"
argument_list|,
name|settings
lambda|->
block|{
name|long
name|defaultReceiverPredictor
init|=
literal|512
operator|*
literal|1024
decl_stmt|;
if|if
condition|(
name|JvmInfo
operator|.
name|jvmInfo
argument_list|()
operator|.
name|getMem
argument_list|()
operator|.
name|getDirectMemoryMax
argument_list|()
operator|.
name|bytes
argument_list|()
operator|>
literal|0
condition|)
block|{
comment|// we can guess a better default...
name|long
name|l
init|=
call|(
name|long
call|)
argument_list|(
operator|(
literal|0.3
operator|*
name|JvmInfo
operator|.
name|jvmInfo
argument_list|()
operator|.
name|getMem
argument_list|()
operator|.
name|getDirectMemoryMax
argument_list|()
operator|.
name|bytes
argument_list|()
operator|)
operator|/
name|WORKER_COUNT
operator|.
name|get
argument_list|(
name|settings
argument_list|)
argument_list|)
decl_stmt|;
name|defaultReceiverPredictor
operator|=
name|Math
operator|.
name|min
argument_list|(
name|defaultReceiverPredictor
argument_list|,
name|Math
operator|.
name|max
argument_list|(
name|l
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|new
name|ByteSizeValue
argument_list|(
name|defaultReceiverPredictor
argument_list|)
operator|.
name|toString
argument_list|()
return|;
block|}
argument_list|,
name|Property
operator|.
name|NodeScope
argument_list|)
decl_stmt|;
DECL|field|NETTY_RECEIVE_PREDICTOR_MIN
specifier|public
specifier|static
specifier|final
name|Setting
argument_list|<
name|ByteSizeValue
argument_list|>
name|NETTY_RECEIVE_PREDICTOR_MIN
init|=
name|byteSizeSetting
argument_list|(
literal|"transport.netty.receive_predictor_min"
argument_list|,
name|NETTY_RECEIVE_PREDICTOR_SIZE
argument_list|,
name|Property
operator|.
name|NodeScope
argument_list|)
decl_stmt|;
DECL|field|NETTY_RECEIVE_PREDICTOR_MAX
specifier|public
specifier|static
specifier|final
name|Setting
argument_list|<
name|ByteSizeValue
argument_list|>
name|NETTY_RECEIVE_PREDICTOR_MAX
init|=
name|byteSizeSetting
argument_list|(
literal|"transport.netty.receive_predictor_max"
argument_list|,
name|NETTY_RECEIVE_PREDICTOR_SIZE
argument_list|,
name|Property
operator|.
name|NodeScope
argument_list|)
decl_stmt|;
DECL|field|NETTY_BOSS_COUNT
specifier|public
specifier|static
specifier|final
name|Setting
argument_list|<
name|Integer
argument_list|>
name|NETTY_BOSS_COUNT
init|=
name|intSetting
argument_list|(
literal|"transport.netty.boss_count"
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|Property
operator|.
name|NodeScope
argument_list|)
decl_stmt|;
DECL|field|maxCumulationBufferCapacity
specifier|protected
specifier|final
name|ByteSizeValue
name|maxCumulationBufferCapacity
decl_stmt|;
DECL|field|maxCompositeBufferComponents
specifier|protected
specifier|final
name|int
name|maxCompositeBufferComponents
decl_stmt|;
DECL|field|receiveBufferSizePredictorFactory
specifier|protected
specifier|final
name|ReceiveBufferSizePredictorFactory
name|receiveBufferSizePredictorFactory
decl_stmt|;
DECL|field|workerCount
specifier|protected
specifier|final
name|int
name|workerCount
decl_stmt|;
DECL|field|receivePredictorMin
specifier|protected
specifier|final
name|ByteSizeValue
name|receivePredictorMin
decl_stmt|;
DECL|field|receivePredictorMax
specifier|protected
specifier|final
name|ByteSizeValue
name|receivePredictorMax
decl_stmt|;
comment|// package private for testing
DECL|field|serverOpenChannels
specifier|volatile
name|OpenChannelsHandler
name|serverOpenChannels
decl_stmt|;
DECL|field|clientBootstrap
specifier|protected
specifier|volatile
name|ClientBootstrap
name|clientBootstrap
decl_stmt|;
DECL|field|serverBootstraps
specifier|protected
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|ServerBootstrap
argument_list|>
name|serverBootstraps
init|=
name|newConcurrentMap
argument_list|()
decl_stmt|;
annotation|@
name|Inject
DECL|method|NettyTransport
specifier|public
name|NettyTransport
parameter_list|(
name|Settings
name|settings
parameter_list|,
name|ThreadPool
name|threadPool
parameter_list|,
name|NetworkService
name|networkService
parameter_list|,
name|BigArrays
name|bigArrays
parameter_list|,
name|NamedWriteableRegistry
name|namedWriteableRegistry
parameter_list|,
name|CircuitBreakerService
name|circuitBreakerService
parameter_list|)
block|{
name|super
argument_list|(
literal|"netty"
argument_list|,
name|settings
argument_list|,
name|threadPool
argument_list|,
name|bigArrays
argument_list|,
name|circuitBreakerService
argument_list|,
name|namedWriteableRegistry
argument_list|,
name|networkService
argument_list|)
expr_stmt|;
name|this
operator|.
name|workerCount
operator|=
name|WORKER_COUNT
operator|.
name|get
argument_list|(
name|settings
argument_list|)
expr_stmt|;
name|this
operator|.
name|maxCumulationBufferCapacity
operator|=
name|NETTY_MAX_CUMULATION_BUFFER_CAPACITY
operator|.
name|get
argument_list|(
name|settings
argument_list|)
expr_stmt|;
name|this
operator|.
name|maxCompositeBufferComponents
operator|=
name|NETTY_MAX_COMPOSITE_BUFFER_COMPONENTS
operator|.
name|get
argument_list|(
name|settings
argument_list|)
expr_stmt|;
comment|// See AdaptiveReceiveBufferSizePredictor#DEFAULT_XXX for default values in netty..., we can use higher ones for us, even fixed one
name|this
operator|.
name|receivePredictorMin
operator|=
name|NETTY_RECEIVE_PREDICTOR_MIN
operator|.
name|get
argument_list|(
name|settings
argument_list|)
expr_stmt|;
name|this
operator|.
name|receivePredictorMax
operator|=
name|NETTY_RECEIVE_PREDICTOR_MAX
operator|.
name|get
argument_list|(
name|settings
argument_list|)
expr_stmt|;
if|if
condition|(
name|receivePredictorMax
operator|.
name|bytes
argument_list|()
operator|==
name|receivePredictorMin
operator|.
name|bytes
argument_list|()
condition|)
block|{
name|receiveBufferSizePredictorFactory
operator|=
operator|new
name|FixedReceiveBufferSizePredictorFactory
argument_list|(
operator|(
name|int
operator|)
name|receivePredictorMax
operator|.
name|bytes
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|receiveBufferSizePredictorFactory
operator|=
operator|new
name|AdaptiveReceiveBufferSizePredictorFactory
argument_list|(
operator|(
name|int
operator|)
name|receivePredictorMin
operator|.
name|bytes
argument_list|()
argument_list|,
operator|(
name|int
operator|)
name|receivePredictorMin
operator|.
name|bytes
argument_list|()
argument_list|,
operator|(
name|int
operator|)
name|receivePredictorMax
operator|.
name|bytes
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|transportServiceAdapter
name|TransportServiceAdapter
name|transportServiceAdapter
parameter_list|()
block|{
return|return
name|transportServiceAdapter
return|;
block|}
annotation|@
name|Override
DECL|method|doStart
specifier|protected
name|void
name|doStart
parameter_list|()
block|{
name|boolean
name|success
init|=
literal|false
decl_stmt|;
try|try
block|{
name|clientBootstrap
operator|=
name|createClientBootstrap
argument_list|()
expr_stmt|;
if|if
condition|(
name|NetworkService
operator|.
name|NETWORK_SERVER
operator|.
name|get
argument_list|(
name|settings
argument_list|)
condition|)
block|{
specifier|final
name|OpenChannelsHandler
name|openChannels
init|=
operator|new
name|OpenChannelsHandler
argument_list|(
name|logger
argument_list|)
decl_stmt|;
name|this
operator|.
name|serverOpenChannels
operator|=
name|openChannels
expr_stmt|;
comment|// loop through all profiles and start them up, special handling for default one
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|Settings
argument_list|>
name|entry
range|:
name|buildProfileSettings
argument_list|()
operator|.
name|entrySet
argument_list|()
control|)
block|{
comment|// merge fallback settings with default settings with profile settings so we have complete settings with default values
specifier|final
name|Settings
name|settings
init|=
name|Settings
operator|.
name|builder
argument_list|()
operator|.
name|put
argument_list|(
name|createFallbackSettings
argument_list|()
argument_list|)
operator|.
name|put
argument_list|(
name|entry
operator|.
name|getValue
argument_list|()
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|createServerBootstrap
argument_list|(
name|entry
operator|.
name|getKey
argument_list|()
argument_list|,
name|settings
argument_list|)
expr_stmt|;
name|bindServer
argument_list|(
name|entry
operator|.
name|getKey
argument_list|()
argument_list|,
name|settings
argument_list|)
expr_stmt|;
block|}
block|}
name|super
operator|.
name|doStart
argument_list|()
expr_stmt|;
name|success
operator|=
literal|true
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|success
operator|==
literal|false
condition|)
block|{
name|doStop
argument_list|()
expr_stmt|;
block|}
block|}
block|}
DECL|method|createClientBootstrap
specifier|private
name|ClientBootstrap
name|createClientBootstrap
parameter_list|()
block|{
comment|// this doPrivileged is for SelectorUtil.java that tries to set "sun.nio.ch.bugLevel"
name|AccessController
operator|.
name|doPrivileged
argument_list|(
call|(
name|PrivilegedAction
argument_list|<
name|Object
argument_list|>
call|)
argument_list|()
operator|->
block|{
if|if
condition|(
name|blockingClient
condition|)
block|{
name|clientBootstrap
operator|=
operator|new
name|ClientBootstrap
argument_list|(
operator|new
name|OioClientSocketChannelFactory
argument_list|(
name|Executors
operator|.
name|newCachedThreadPool
argument_list|(
name|daemonThreadFactory
argument_list|(
name|settings
argument_list|,
name|TRANSPORT_CLIENT_WORKER_THREAD_NAME_PREFIX
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|bossCount
init|=
name|NETTY_BOSS_COUNT
operator|.
name|get
argument_list|(
name|settings
argument_list|)
decl_stmt|;
name|clientBootstrap
operator|=
operator|new
name|ClientBootstrap
argument_list|(
operator|new
name|NioClientSocketChannelFactory
argument_list|(
name|Executors
operator|.
name|newCachedThreadPool
argument_list|(
name|daemonThreadFactory
argument_list|(
name|settings
argument_list|,
name|TRANSPORT_CLIENT_BOSS_THREAD_NAME_PREFIX
argument_list|)
argument_list|)
argument_list|,
name|bossCount
argument_list|,
operator|new
name|NioWorkerPool
argument_list|(
name|Executors
operator|.
name|newCachedThreadPool
argument_list|(
name|daemonThreadFactory
argument_list|(
name|settings
argument_list|,
name|TRANSPORT_CLIENT_WORKER_THREAD_NAME_PREFIX
argument_list|)
argument_list|)
argument_list|,
name|workerCount
argument_list|)
argument_list|,
operator|new
name|HashedWheelTimer
argument_list|(
name|daemonThreadFactory
argument_list|(
name|settings
argument_list|,
literal|"transport_client_timer"
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
argument_list|return
literal|null
argument_list|;
block|}
block|)
class|;
end_class

begin_assert
assert|assert
name|System
operator|.
name|getProperty
argument_list|(
literal|"sun.nio.ch.bugLevel"
argument_list|)
operator|!=
literal|null
operator|:
literal|"sun.nio.ch.bugLevel is null somebody pulls in SelectorUtil without doing stuff in a doPrivileged block?"
assert|;
end_assert

begin_expr_stmt
name|clientBootstrap
operator|.
name|setPipelineFactory
argument_list|(
name|configureClientChannelPipelineFactory
argument_list|()
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|clientBootstrap
operator|.
name|setOption
argument_list|(
literal|"connectTimeoutMillis"
argument_list|,
name|connectTimeout
operator|.
name|millis
argument_list|()
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|boolean
name|tcpNoDelay
init|=
name|TCP_NO_DELAY
operator|.
name|get
argument_list|(
name|settings
argument_list|)
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|clientBootstrap
operator|.
name|setOption
argument_list|(
literal|"tcpNoDelay"
argument_list|,
name|tcpNoDelay
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|boolean
name|tcpKeepAlive
init|=
name|TCP_KEEP_ALIVE
operator|.
name|get
argument_list|(
name|settings
argument_list|)
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|clientBootstrap
operator|.
name|setOption
argument_list|(
literal|"keepAlive"
argument_list|,
name|tcpKeepAlive
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|ByteSizeValue
name|tcpSendBufferSize
init|=
name|TCP_SEND_BUFFER_SIZE
operator|.
name|get
argument_list|(
name|settings
argument_list|)
decl_stmt|;
end_decl_stmt

begin_if
if|if
condition|(
name|tcpSendBufferSize
operator|.
name|bytes
argument_list|()
operator|>
literal|0
condition|)
block|{
name|clientBootstrap
operator|.
name|setOption
argument_list|(
literal|"sendBufferSize"
argument_list|,
name|tcpSendBufferSize
operator|.
name|bytes
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_if

begin_decl_stmt
name|ByteSizeValue
name|tcpReceiveBufferSize
init|=
name|TCP_RECEIVE_BUFFER_SIZE
operator|.
name|get
argument_list|(
name|settings
argument_list|)
decl_stmt|;
end_decl_stmt

begin_if
if|if
condition|(
name|tcpReceiveBufferSize
operator|.
name|bytes
argument_list|()
operator|>
literal|0
condition|)
block|{
name|clientBootstrap
operator|.
name|setOption
argument_list|(
literal|"receiveBufferSize"
argument_list|,
name|tcpReceiveBufferSize
operator|.
name|bytes
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|clientBootstrap
operator|.
name|setOption
argument_list|(
literal|"receiveBufferSizePredictorFactory"
argument_list|,
name|receiveBufferSizePredictorFactory
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|boolean
name|reuseAddress
init|=
name|TCP_REUSE_ADDRESS
operator|.
name|get
argument_list|(
name|settings
argument_list|)
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|clientBootstrap
operator|.
name|setOption
argument_list|(
literal|"reuseAddress"
argument_list|,
name|reuseAddress
argument_list|)
expr_stmt|;
end_expr_stmt

begin_return
return|return
name|clientBootstrap
return|;
end_return

begin_function
unit|}      private
DECL|method|createFallbackSettings
name|Settings
name|createFallbackSettings
parameter_list|()
block|{
name|Settings
operator|.
name|Builder
name|fallbackSettingsBuilder
init|=
name|Settings
operator|.
name|builder
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fallbackBindHost
init|=
name|TransportSettings
operator|.
name|BIND_HOST
operator|.
name|get
argument_list|(
name|settings
argument_list|)
decl_stmt|;
if|if
condition|(
name|fallbackBindHost
operator|.
name|isEmpty
argument_list|()
operator|==
literal|false
condition|)
block|{
name|fallbackSettingsBuilder
operator|.
name|putArray
argument_list|(
literal|"bind_host"
argument_list|,
name|fallbackBindHost
argument_list|)
expr_stmt|;
block|}
name|List
argument_list|<
name|String
argument_list|>
name|fallbackPublishHost
init|=
name|TransportSettings
operator|.
name|PUBLISH_HOST
operator|.
name|get
argument_list|(
name|settings
argument_list|)
decl_stmt|;
if|if
condition|(
name|fallbackPublishHost
operator|.
name|isEmpty
argument_list|()
operator|==
literal|false
condition|)
block|{
name|fallbackSettingsBuilder
operator|.
name|putArray
argument_list|(
literal|"publish_host"
argument_list|,
name|fallbackPublishHost
argument_list|)
expr_stmt|;
block|}
name|boolean
name|fallbackTcpNoDelay
init|=
name|settings
operator|.
name|getAsBoolean
argument_list|(
literal|"transport.netty.tcp_no_delay"
argument_list|,
name|TcpSettings
operator|.
name|TCP_NO_DELAY
operator|.
name|get
argument_list|(
name|settings
argument_list|)
argument_list|)
decl_stmt|;
name|fallbackSettingsBuilder
operator|.
name|put
argument_list|(
literal|"tcp_no_delay"
argument_list|,
name|fallbackTcpNoDelay
argument_list|)
expr_stmt|;
name|boolean
name|fallbackTcpKeepAlive
init|=
name|settings
operator|.
name|getAsBoolean
argument_list|(
literal|"transport.netty.tcp_keep_alive"
argument_list|,
name|TcpSettings
operator|.
name|TCP_KEEP_ALIVE
operator|.
name|get
argument_list|(
name|settings
argument_list|)
argument_list|)
decl_stmt|;
name|fallbackSettingsBuilder
operator|.
name|put
argument_list|(
literal|"tcp_keep_alive"
argument_list|,
name|fallbackTcpKeepAlive
argument_list|)
expr_stmt|;
name|boolean
name|fallbackReuseAddress
init|=
name|settings
operator|.
name|getAsBoolean
argument_list|(
literal|"transport.netty.reuse_address"
argument_list|,
name|TcpSettings
operator|.
name|TCP_REUSE_ADDRESS
operator|.
name|get
argument_list|(
name|settings
argument_list|)
argument_list|)
decl_stmt|;
name|fallbackSettingsBuilder
operator|.
name|put
argument_list|(
literal|"reuse_address"
argument_list|,
name|fallbackReuseAddress
argument_list|)
expr_stmt|;
name|ByteSizeValue
name|fallbackTcpSendBufferSize
init|=
name|settings
operator|.
name|getAsBytesSize
argument_list|(
literal|"transport.netty.tcp_send_buffer_size"
argument_list|,
name|TCP_SEND_BUFFER_SIZE
operator|.
name|get
argument_list|(
name|settings
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|fallbackTcpSendBufferSize
operator|.
name|bytes
argument_list|()
operator|>=
literal|0
condition|)
block|{
name|fallbackSettingsBuilder
operator|.
name|put
argument_list|(
literal|"tcp_send_buffer_size"
argument_list|,
name|fallbackTcpSendBufferSize
argument_list|)
expr_stmt|;
block|}
name|ByteSizeValue
name|fallbackTcpBufferSize
init|=
name|settings
operator|.
name|getAsBytesSize
argument_list|(
literal|"transport.netty.tcp_receive_buffer_size"
argument_list|,
name|TCP_RECEIVE_BUFFER_SIZE
operator|.
name|get
argument_list|(
name|settings
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|fallbackTcpBufferSize
operator|.
name|bytes
argument_list|()
operator|>=
literal|0
condition|)
block|{
name|fallbackSettingsBuilder
operator|.
name|put
argument_list|(
literal|"tcp_receive_buffer_size"
argument_list|,
name|fallbackTcpBufferSize
argument_list|)
expr_stmt|;
block|}
return|return
name|fallbackSettingsBuilder
operator|.
name|build
argument_list|()
return|;
block|}
end_function

begin_function
DECL|method|createServerBootstrap
specifier|private
name|void
name|createServerBootstrap
parameter_list|(
name|String
name|name
parameter_list|,
name|Settings
name|settings
parameter_list|)
block|{
name|boolean
name|blockingServer
init|=
name|TCP_BLOCKING_SERVER
operator|.
name|get
argument_list|(
name|settings
argument_list|)
decl_stmt|;
name|String
name|port
init|=
name|settings
operator|.
name|get
argument_list|(
literal|"port"
argument_list|)
decl_stmt|;
name|String
name|bindHost
init|=
name|settings
operator|.
name|get
argument_list|(
literal|"bind_host"
argument_list|)
decl_stmt|;
name|String
name|publishHost
init|=
name|settings
operator|.
name|get
argument_list|(
literal|"publish_host"
argument_list|)
decl_stmt|;
name|String
name|tcpNoDelay
init|=
name|settings
operator|.
name|get
argument_list|(
literal|"tcp_no_delay"
argument_list|)
decl_stmt|;
name|String
name|tcpKeepAlive
init|=
name|settings
operator|.
name|get
argument_list|(
literal|"tcp_keep_alive"
argument_list|)
decl_stmt|;
name|boolean
name|reuseAddress
init|=
name|settings
operator|.
name|getAsBoolean
argument_list|(
literal|"reuse_address"
argument_list|,
name|NetworkUtils
operator|.
name|defaultReuseAddress
argument_list|()
argument_list|)
decl_stmt|;
name|ByteSizeValue
name|tcpSendBufferSize
init|=
name|TCP_SEND_BUFFER_SIZE
operator|.
name|getDefault
argument_list|(
name|settings
argument_list|)
decl_stmt|;
name|ByteSizeValue
name|tcpReceiveBufferSize
init|=
name|TCP_RECEIVE_BUFFER_SIZE
operator|.
name|getDefault
argument_list|(
name|settings
argument_list|)
decl_stmt|;
if|if
condition|(
name|logger
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|logger
operator|.
name|debug
argument_list|(
literal|"using profile[{}], worker_count[{}], port[{}], bind_host[{}], publish_host[{}], compress[{}], "
operator|+
literal|"connect_timeout[{}], connections_per_node[{}/{}/{}/{}/{}], receive_predictor[{}->{}]"
argument_list|,
name|name
argument_list|,
name|workerCount
argument_list|,
name|port
argument_list|,
name|bindHost
argument_list|,
name|publishHost
argument_list|,
name|compress
argument_list|,
name|connectTimeout
argument_list|,
name|connectionsPerNodeRecovery
argument_list|,
name|connectionsPerNodeBulk
argument_list|,
name|connectionsPerNodeReg
argument_list|,
name|connectionsPerNodeState
argument_list|,
name|connectionsPerNodePing
argument_list|,
name|receivePredictorMin
argument_list|,
name|receivePredictorMax
argument_list|)
expr_stmt|;
block|}
specifier|final
name|ThreadFactory
name|bossFactory
init|=
name|daemonThreadFactory
argument_list|(
name|this
operator|.
name|settings
argument_list|,
name|HTTP_SERVER_BOSS_THREAD_NAME_PREFIX
argument_list|,
name|name
argument_list|)
decl_stmt|;
specifier|final
name|ThreadFactory
name|workerFactory
init|=
name|daemonThreadFactory
argument_list|(
name|this
operator|.
name|settings
argument_list|,
name|HTTP_SERVER_WORKER_THREAD_NAME_PREFIX
argument_list|,
name|name
argument_list|)
decl_stmt|;
comment|// this doPrivileged is for SelectorUtil.java that tries to set "sun.nio.ch.bugLevel"
name|ServerBootstrap
name|serverBootstrap
init|=
name|AccessController
operator|.
name|doPrivileged
argument_list|(
call|(
name|PrivilegedAction
argument_list|<
name|ServerBootstrap
argument_list|>
call|)
argument_list|()
operator|->
block|{
if|if
condition|(
name|blockingServer
condition|)
block|{
return|return
operator|new
name|ServerBootstrap
argument_list|(
operator|new
name|OioServerSocketChannelFactory
argument_list|(
name|Executors
operator|.
name|newCachedThreadPool
argument_list|(
name|bossFactory
argument_list|)
argument_list|,
name|Executors
operator|.
name|newCachedThreadPool
argument_list|(
name|workerFactory
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
return|return
operator|new
name|ServerBootstrap
argument_list|(
operator|new
name|NioServerSocketChannelFactory
argument_list|(
name|Executors
operator|.
name|newCachedThreadPool
argument_list|(
name|bossFactory
argument_list|)
argument_list|,
name|Executors
operator|.
name|newCachedThreadPool
argument_list|(
name|workerFactory
argument_list|)
argument_list|,
name|workerCount
argument_list|)
argument_list|)
return|;
block|}
block|}
argument_list|)
decl_stmt|;
assert|assert
name|System
operator|.
name|getProperty
argument_list|(
literal|"sun.nio.ch.bugLevel"
argument_list|)
operator|!=
literal|null
operator|:
literal|"sun.nio.ch.bugLevel is null somebody pulls in SelectorUtil without doing stuff in a doPrivileged block?"
assert|;
name|serverBootstrap
operator|.
name|setPipelineFactory
argument_list|(
name|configureServerChannelPipelineFactory
argument_list|(
name|name
argument_list|,
name|settings
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
literal|"default"
operator|.
name|equals
argument_list|(
name|tcpNoDelay
argument_list|)
condition|)
block|{
name|serverBootstrap
operator|.
name|setOption
argument_list|(
literal|"child.tcpNoDelay"
argument_list|,
name|Booleans
operator|.
name|parseBoolean
argument_list|(
name|tcpNoDelay
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
literal|"default"
operator|.
name|equals
argument_list|(
name|tcpKeepAlive
argument_list|)
condition|)
block|{
name|serverBootstrap
operator|.
name|setOption
argument_list|(
literal|"child.keepAlive"
argument_list|,
name|Booleans
operator|.
name|parseBoolean
argument_list|(
name|tcpKeepAlive
argument_list|,
literal|null
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tcpSendBufferSize
operator|!=
literal|null
operator|&&
name|tcpSendBufferSize
operator|.
name|bytes
argument_list|()
operator|>
literal|0
condition|)
block|{
name|serverBootstrap
operator|.
name|setOption
argument_list|(
literal|"child.sendBufferSize"
argument_list|,
name|tcpSendBufferSize
operator|.
name|bytes
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tcpReceiveBufferSize
operator|!=
literal|null
operator|&&
name|tcpReceiveBufferSize
operator|.
name|bytes
argument_list|()
operator|>
literal|0
condition|)
block|{
name|serverBootstrap
operator|.
name|setOption
argument_list|(
literal|"child.receiveBufferSize"
argument_list|,
name|tcpReceiveBufferSize
operator|.
name|bytes
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|serverBootstrap
operator|.
name|setOption
argument_list|(
literal|"receiveBufferSizePredictorFactory"
argument_list|,
name|receiveBufferSizePredictorFactory
argument_list|)
expr_stmt|;
name|serverBootstrap
operator|.
name|setOption
argument_list|(
literal|"child.receiveBufferSizePredictorFactory"
argument_list|,
name|receiveBufferSizePredictorFactory
argument_list|)
expr_stmt|;
name|serverBootstrap
operator|.
name|setOption
argument_list|(
literal|"reuseAddress"
argument_list|,
name|reuseAddress
argument_list|)
expr_stmt|;
name|serverBootstrap
operator|.
name|setOption
argument_list|(
literal|"child.reuseAddress"
argument_list|,
name|reuseAddress
argument_list|)
expr_stmt|;
name|serverBootstraps
operator|.
name|put
argument_list|(
name|name
argument_list|,
name|serverBootstrap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|exceptionCaught
specifier|protected
specifier|final
name|void
name|exceptionCaught
parameter_list|(
name|ChannelHandlerContext
name|ctx
parameter_list|,
name|ExceptionEvent
name|e
parameter_list|)
throws|throws
name|Exception
block|{
name|onException
argument_list|(
name|ctx
operator|.
name|getChannel
argument_list|()
argument_list|,
name|e
operator|.
name|getCause
argument_list|()
operator|==
literal|null
operator|||
name|e
operator|.
name|getCause
argument_list|()
operator|instanceof
name|Exception
condition|?
operator|(
name|Exception
operator|)
name|e
operator|.
name|getCause
argument_list|()
else|:
operator|new
name|ElasticsearchException
argument_list|(
name|e
operator|.
name|getCause
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|serverOpen
specifier|public
name|long
name|serverOpen
parameter_list|()
block|{
name|OpenChannelsHandler
name|channels
init|=
name|serverOpenChannels
decl_stmt|;
return|return
name|channels
operator|==
literal|null
condition|?
literal|0
else|:
name|channels
operator|.
name|numberOfOpenChannels
argument_list|()
return|;
block|}
end_function

begin_function
DECL|method|connectToChannelsLight
specifier|protected
name|NodeChannels
name|connectToChannelsLight
parameter_list|(
name|DiscoveryNode
name|node
parameter_list|)
block|{
name|InetSocketAddress
name|address
init|=
operator|(
operator|(
name|InetSocketTransportAddress
operator|)
name|node
operator|.
name|getAddress
argument_list|()
operator|)
operator|.
name|address
argument_list|()
decl_stmt|;
name|ChannelFuture
name|connect
init|=
name|clientBootstrap
operator|.
name|connect
argument_list|(
name|address
argument_list|)
decl_stmt|;
name|connect
operator|.
name|awaitUninterruptibly
argument_list|(
call|(
name|long
call|)
argument_list|(
name|connectTimeout
operator|.
name|millis
argument_list|()
operator|*
literal|1.5
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|connect
operator|.
name|isSuccess
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|ConnectTransportException
argument_list|(
name|node
argument_list|,
literal|"connect_timeout["
operator|+
name|connectTimeout
operator|+
literal|"]"
argument_list|,
name|connect
operator|.
name|getCause
argument_list|()
argument_list|)
throw|;
block|}
name|Channel
index|[]
name|channels
init|=
operator|new
name|Channel
index|[
literal|1
index|]
decl_stmt|;
name|channels
index|[
literal|0
index|]
operator|=
name|connect
operator|.
name|getChannel
argument_list|()
expr_stmt|;
name|channels
index|[
literal|0
index|]
operator|.
name|getCloseFuture
argument_list|()
operator|.
name|addListener
argument_list|(
operator|new
name|ChannelCloseListener
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|new
name|NodeChannels
argument_list|(
name|channels
argument_list|,
name|channels
argument_list|,
name|channels
argument_list|,
name|channels
argument_list|,
name|channels
argument_list|)
return|;
block|}
end_function

begin_function
DECL|method|connectToChannels
specifier|protected
name|NodeChannels
name|connectToChannels
parameter_list|(
name|DiscoveryNode
name|node
parameter_list|)
throws|throws
name|IOException
block|{
specifier|final
name|NodeChannels
name|nodeChannels
init|=
operator|new
name|NodeChannels
argument_list|(
operator|new
name|Channel
index|[
name|connectionsPerNodeRecovery
index|]
argument_list|,
operator|new
name|Channel
index|[
name|connectionsPerNodeBulk
index|]
argument_list|,
operator|new
name|Channel
index|[
name|connectionsPerNodeReg
index|]
argument_list|,
operator|new
name|Channel
index|[
name|connectionsPerNodeState
index|]
argument_list|,
operator|new
name|Channel
index|[
name|connectionsPerNodePing
index|]
argument_list|)
decl_stmt|;
name|boolean
name|success
init|=
literal|false
decl_stmt|;
try|try
block|{
name|int
name|numConnections
init|=
name|connectionsPerNodeBulk
operator|+
name|connectionsPerNodePing
operator|+
name|connectionsPerNodeRecovery
operator|+
name|connectionsPerNodeReg
operator|+
name|connectionsPerNodeState
decl_stmt|;
name|ArrayList
argument_list|<
name|ChannelFuture
argument_list|>
name|connections
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|InetSocketAddress
name|address
init|=
operator|(
operator|(
name|InetSocketTransportAddress
operator|)
name|node
operator|.
name|getAddress
argument_list|()
operator|)
operator|.
name|address
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|numConnections
condition|;
name|i
operator|++
control|)
block|{
name|connections
operator|.
name|add
argument_list|(
name|clientBootstrap
operator|.
name|connect
argument_list|(
name|address
argument_list|)
argument_list|)
expr_stmt|;
block|}
specifier|final
name|Iterator
argument_list|<
name|ChannelFuture
argument_list|>
name|iterator
init|=
name|connections
operator|.
name|iterator
argument_list|()
decl_stmt|;
try|try
block|{
for|for
control|(
name|Channel
index|[]
name|channels
range|:
name|nodeChannels
operator|.
name|getChannelArrays
argument_list|()
control|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|channels
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
assert|assert
name|iterator
operator|.
name|hasNext
argument_list|()
assert|;
name|ChannelFuture
name|future
init|=
name|iterator
operator|.
name|next
argument_list|()
decl_stmt|;
name|future
operator|.
name|awaitUninterruptibly
argument_list|(
call|(
name|long
call|)
argument_list|(
name|connectTimeout
operator|.
name|millis
argument_list|()
operator|*
literal|1.5
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|future
operator|.
name|isSuccess
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|ConnectTransportException
argument_list|(
name|node
argument_list|,
literal|"connect_timeout["
operator|+
name|connectTimeout
operator|+
literal|"]"
argument_list|,
name|future
operator|.
name|getCause
argument_list|()
argument_list|)
throw|;
block|}
name|channels
index|[
name|i
index|]
operator|=
name|future
operator|.
name|getChannel
argument_list|()
expr_stmt|;
name|channels
index|[
name|i
index|]
operator|.
name|getCloseFuture
argument_list|()
operator|.
name|addListener
argument_list|(
operator|new
name|ChannelCloseListener
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nodeChannels
operator|.
name|recovery
operator|.
name|length
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|nodeChannels
operator|.
name|bulk
operator|.
name|length
operator|>
literal|0
condition|)
block|{
name|nodeChannels
operator|.
name|recovery
operator|=
name|nodeChannels
operator|.
name|bulk
expr_stmt|;
block|}
else|else
block|{
name|nodeChannels
operator|.
name|recovery
operator|=
name|nodeChannels
operator|.
name|reg
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nodeChannels
operator|.
name|bulk
operator|.
name|length
operator|==
literal|0
condition|)
block|{
name|nodeChannels
operator|.
name|bulk
operator|=
name|nodeChannels
operator|.
name|reg
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|RuntimeException
name|e
parameter_list|)
block|{
for|for
control|(
name|ChannelFuture
name|future
range|:
name|Collections
operator|.
name|unmodifiableList
argument_list|(
name|connections
argument_list|)
control|)
block|{
name|future
operator|.
name|cancel
argument_list|()
expr_stmt|;
if|if
condition|(
name|future
operator|.
name|getChannel
argument_list|()
operator|!=
literal|null
operator|&&
name|future
operator|.
name|getChannel
argument_list|()
operator|.
name|isOpen
argument_list|()
condition|)
block|{
try|try
block|{
name|future
operator|.
name|getChannel
argument_list|()
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e1
parameter_list|)
block|{
comment|// ignore
block|}
block|}
block|}
throw|throw
name|e
throw|;
block|}
name|success
operator|=
literal|true
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|success
operator|==
literal|false
condition|)
block|{
name|nodeChannels
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
return|return
name|nodeChannels
return|;
block|}
end_function

begin_function
DECL|method|configureClientChannelPipelineFactory
specifier|public
name|ChannelPipelineFactory
name|configureClientChannelPipelineFactory
parameter_list|()
block|{
return|return
operator|new
name|ClientChannelPipelineFactory
argument_list|(
name|this
argument_list|)
return|;
block|}
end_function

begin_class
DECL|class|ClientChannelPipelineFactory
specifier|protected
specifier|static
class|class
name|ClientChannelPipelineFactory
implements|implements
name|ChannelPipelineFactory
block|{
DECL|field|nettyTransport
specifier|protected
specifier|final
name|NettyTransport
name|nettyTransport
decl_stmt|;
DECL|method|ClientChannelPipelineFactory
specifier|public
name|ClientChannelPipelineFactory
parameter_list|(
name|NettyTransport
name|nettyTransport
parameter_list|)
block|{
name|this
operator|.
name|nettyTransport
operator|=
name|nettyTransport
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getPipeline
specifier|public
name|ChannelPipeline
name|getPipeline
parameter_list|()
throws|throws
name|Exception
block|{
name|ChannelPipeline
name|channelPipeline
init|=
name|Channels
operator|.
name|pipeline
argument_list|()
decl_stmt|;
name|SizeHeaderFrameDecoder
name|sizeHeader
init|=
operator|new
name|SizeHeaderFrameDecoder
argument_list|()
decl_stmt|;
if|if
condition|(
name|nettyTransport
operator|.
name|maxCumulationBufferCapacity
operator|.
name|bytes
argument_list|()
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|nettyTransport
operator|.
name|maxCumulationBufferCapacity
operator|.
name|bytes
argument_list|()
operator|>
name|Integer
operator|.
name|MAX_VALUE
condition|)
block|{
name|sizeHeader
operator|.
name|setMaxCumulationBufferCapacity
argument_list|(
name|Integer
operator|.
name|MAX_VALUE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sizeHeader
operator|.
name|setMaxCumulationBufferCapacity
argument_list|(
operator|(
name|int
operator|)
name|nettyTransport
operator|.
name|maxCumulationBufferCapacity
operator|.
name|bytes
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nettyTransport
operator|.
name|maxCompositeBufferComponents
operator|!=
operator|-
literal|1
condition|)
block|{
name|sizeHeader
operator|.
name|setMaxCumulationBufferComponents
argument_list|(
name|nettyTransport
operator|.
name|maxCompositeBufferComponents
argument_list|)
expr_stmt|;
block|}
name|channelPipeline
operator|.
name|addLast
argument_list|(
literal|"size"
argument_list|,
name|sizeHeader
argument_list|)
expr_stmt|;
comment|// using a dot as a prefix means, this cannot come from any settings parsed
name|channelPipeline
operator|.
name|addLast
argument_list|(
literal|"dispatcher"
argument_list|,
operator|new
name|NettyMessageChannelHandler
argument_list|(
name|nettyTransport
argument_list|,
literal|".client"
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|channelPipeline
return|;
block|}
block|}
end_class

begin_function
DECL|method|configureServerChannelPipelineFactory
specifier|public
name|ChannelPipelineFactory
name|configureServerChannelPipelineFactory
parameter_list|(
name|String
name|name
parameter_list|,
name|Settings
name|settings
parameter_list|)
block|{
return|return
operator|new
name|ServerChannelPipelineFactory
argument_list|(
name|this
argument_list|,
name|name
argument_list|,
name|settings
argument_list|)
return|;
block|}
end_function

begin_class
DECL|class|ServerChannelPipelineFactory
specifier|protected
specifier|static
class|class
name|ServerChannelPipelineFactory
implements|implements
name|ChannelPipelineFactory
block|{
DECL|field|nettyTransport
specifier|protected
specifier|final
name|NettyTransport
name|nettyTransport
decl_stmt|;
DECL|field|name
specifier|protected
specifier|final
name|String
name|name
decl_stmt|;
DECL|field|settings
specifier|protected
specifier|final
name|Settings
name|settings
decl_stmt|;
DECL|method|ServerChannelPipelineFactory
specifier|public
name|ServerChannelPipelineFactory
parameter_list|(
name|NettyTransport
name|nettyTransport
parameter_list|,
name|String
name|name
parameter_list|,
name|Settings
name|settings
parameter_list|)
block|{
name|this
operator|.
name|nettyTransport
operator|=
name|nettyTransport
expr_stmt|;
name|this
operator|.
name|name
operator|=
name|name
expr_stmt|;
name|this
operator|.
name|settings
operator|=
name|settings
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getPipeline
specifier|public
name|ChannelPipeline
name|getPipeline
parameter_list|()
throws|throws
name|Exception
block|{
name|ChannelPipeline
name|channelPipeline
init|=
name|Channels
operator|.
name|pipeline
argument_list|()
decl_stmt|;
name|channelPipeline
operator|.
name|addLast
argument_list|(
literal|"openChannels"
argument_list|,
name|nettyTransport
operator|.
name|serverOpenChannels
argument_list|)
expr_stmt|;
name|SizeHeaderFrameDecoder
name|sizeHeader
init|=
operator|new
name|SizeHeaderFrameDecoder
argument_list|()
decl_stmt|;
if|if
condition|(
name|nettyTransport
operator|.
name|maxCumulationBufferCapacity
operator|.
name|bytes
argument_list|()
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|nettyTransport
operator|.
name|maxCumulationBufferCapacity
operator|.
name|bytes
argument_list|()
operator|>
name|Integer
operator|.
name|MAX_VALUE
condition|)
block|{
name|sizeHeader
operator|.
name|setMaxCumulationBufferCapacity
argument_list|(
name|Integer
operator|.
name|MAX_VALUE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sizeHeader
operator|.
name|setMaxCumulationBufferCapacity
argument_list|(
operator|(
name|int
operator|)
name|nettyTransport
operator|.
name|maxCumulationBufferCapacity
operator|.
name|bytes
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nettyTransport
operator|.
name|maxCompositeBufferComponents
operator|!=
operator|-
literal|1
condition|)
block|{
name|sizeHeader
operator|.
name|setMaxCumulationBufferComponents
argument_list|(
name|nettyTransport
operator|.
name|maxCompositeBufferComponents
argument_list|)
expr_stmt|;
block|}
name|channelPipeline
operator|.
name|addLast
argument_list|(
literal|"size"
argument_list|,
name|sizeHeader
argument_list|)
expr_stmt|;
name|channelPipeline
operator|.
name|addLast
argument_list|(
literal|"dispatcher"
argument_list|,
operator|new
name|NettyMessageChannelHandler
argument_list|(
name|nettyTransport
argument_list|,
name|name
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|channelPipeline
return|;
block|}
block|}
end_class

begin_class
DECL|class|ChannelCloseListener
specifier|protected
class|class
name|ChannelCloseListener
implements|implements
name|ChannelFutureListener
block|{
DECL|field|node
specifier|private
specifier|final
name|DiscoveryNode
name|node
decl_stmt|;
DECL|method|ChannelCloseListener
specifier|private
name|ChannelCloseListener
parameter_list|(
name|DiscoveryNode
name|node
parameter_list|)
block|{
name|this
operator|.
name|node
operator|=
name|node
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|operationComplete
specifier|public
name|void
name|operationComplete
parameter_list|(
specifier|final
name|ChannelFuture
name|future
parameter_list|)
throws|throws
name|Exception
block|{
name|NodeChannels
name|nodeChannels
init|=
name|connectedNodes
operator|.
name|get
argument_list|(
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|nodeChannels
operator|!=
literal|null
operator|&&
name|nodeChannels
operator|.
name|hasChannel
argument_list|(
name|future
operator|.
name|getChannel
argument_list|()
argument_list|)
condition|)
block|{
name|threadPool
operator|.
name|generic
argument_list|()
operator|.
name|execute
argument_list|(
parameter_list|()
lambda|->
block|{
name|disconnectFromNode
argument_list|(
name|node
argument_list|,
name|future
operator|.
name|getChannel
argument_list|()
argument_list|,
literal|"channel closed event"
argument_list|)
expr_stmt|;
block|}
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_class

begin_function
annotation|@
name|Override
DECL|method|sendMessage
specifier|protected
name|void
name|sendMessage
parameter_list|(
name|Channel
name|channel
parameter_list|,
name|BytesReference
name|reference
parameter_list|,
name|Runnable
name|sendListener
parameter_list|,
name|boolean
name|close
parameter_list|)
block|{
specifier|final
name|ChannelFuture
name|future
init|=
name|channel
operator|.
name|write
argument_list|(
name|NettyUtils
operator|.
name|toChannelBuffer
argument_list|(
name|reference
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|close
condition|)
block|{
name|future
operator|.
name|addListener
argument_list|(
name|f
lambda|->
block|{
try|try
block|{
name|sendListener
operator|.
name|run
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|f
operator|.
name|getChannel
argument_list|()
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|future
operator|.
name|addListener
argument_list|(
name|future1
lambda|->
name|sendListener
operator|.
name|run
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|closeChannels
specifier|protected
name|void
name|closeChannels
parameter_list|(
name|List
argument_list|<
name|Channel
argument_list|>
name|channels
parameter_list|)
block|{
name|List
argument_list|<
name|ChannelFuture
argument_list|>
name|futures
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|Channel
name|channel
range|:
name|channels
control|)
block|{
try|try
block|{
if|if
condition|(
name|channel
operator|!=
literal|null
operator|&&
name|channel
operator|.
name|isOpen
argument_list|()
condition|)
block|{
name|futures
operator|.
name|add
argument_list|(
name|channel
operator|.
name|close
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|logger
operator|.
name|trace
argument_list|(
literal|"failed to close channel"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|ChannelFuture
name|future
range|:
name|futures
control|)
block|{
name|future
operator|.
name|awaitUninterruptibly
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|getLocalAddress
specifier|protected
name|InetSocketAddress
name|getLocalAddress
parameter_list|(
name|Channel
name|channel
parameter_list|)
block|{
return|return
operator|(
name|InetSocketAddress
operator|)
name|channel
operator|.
name|getLocalAddress
argument_list|()
return|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|bind
specifier|protected
name|Channel
name|bind
parameter_list|(
name|String
name|name
parameter_list|,
name|InetSocketAddress
name|address
parameter_list|)
block|{
return|return
name|serverBootstraps
operator|.
name|get
argument_list|(
name|name
argument_list|)
operator|.
name|bind
argument_list|(
name|address
argument_list|)
return|;
block|}
end_function

begin_function
DECL|method|getPing
name|ScheduledPing
name|getPing
parameter_list|()
block|{
return|return
name|scheduledPing
return|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|isOpen
specifier|protected
name|boolean
name|isOpen
parameter_list|(
name|Channel
name|channel
parameter_list|)
block|{
return|return
name|channel
operator|.
name|isOpen
argument_list|()
return|;
block|}
end_function

begin_function
annotation|@
name|Override
DECL|method|stopInternal
specifier|protected
name|void
name|stopInternal
parameter_list|()
block|{
name|Releasables
operator|.
name|close
argument_list|(
name|serverOpenChannels
argument_list|,
parameter_list|()
lambda|->
block|{
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|ServerBootstrap
argument_list|>
name|entry
range|:
name|serverBootstraps
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|String
name|name
init|=
name|entry
operator|.
name|getKey
argument_list|()
decl_stmt|;
name|ServerBootstrap
name|serverBootstrap
init|=
name|entry
operator|.
name|getValue
argument_list|()
decl_stmt|;
try|try
block|{
name|serverBootstrap
operator|.
name|releaseExternalResources
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|logger
operator|.
name|debug
argument_list|(
literal|"Error closing serverBootstrap for profile [{}]"
argument_list|,
name|e
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
name|serverBootstraps
operator|.
name|clear
argument_list|()
expr_stmt|;
if|if
condition|(
name|clientBootstrap
operator|!=
literal|null
condition|)
block|{
name|clientBootstrap
operator|.
name|releaseExternalResources
argument_list|()
expr_stmt|;
name|clientBootstrap
operator|=
literal|null
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
end_function

unit|}
end_unit

