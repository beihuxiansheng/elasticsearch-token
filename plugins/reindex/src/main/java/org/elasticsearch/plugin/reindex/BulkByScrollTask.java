begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to Elasticsearch under one or more contributor  * license agreements. See the NOTICE file distributed with  * this work for additional information regarding copyright  * ownership. Elasticsearch licenses this file to you under  * the Apache License, Version 2.0 (the "License"); you may  * not use this file except in compliance with the License.  * You may obtain a copy of the License at  *  *    http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing,  * software distributed under the License is distributed on an  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  * KIND, either express or implied.  See the License for the  * specific language governing permissions and limitations  * under the License.  */
end_comment

begin_package
DECL|package|org.elasticsearch.plugin.reindex
package|package
name|org
operator|.
name|elasticsearch
operator|.
name|plugin
operator|.
name|reindex
package|;
end_package

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|inject
operator|.
name|Provider
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|io
operator|.
name|stream
operator|.
name|StreamInput
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|io
operator|.
name|stream
operator|.
name|StreamOutput
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|xcontent
operator|.
name|XContentBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|tasks
operator|.
name|Task
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicInteger
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicLong
import|;
end_import

begin_comment
comment|/**  * Task storing information about a currently running BulkByScroll request.  */
end_comment

begin_class
DECL|class|BulkByScrollTask
specifier|public
class|class
name|BulkByScrollTask
extends|extends
name|Task
block|{
comment|/**      * The total number of documents this request will process. 0 means we don't yet know or, possibly, there are actually 0 documents      * to process. Its ok that these have the same meaning because any request with 0 actual documents should be quite short lived.      */
DECL|field|total
specifier|private
specifier|final
name|AtomicLong
name|total
init|=
operator|new
name|AtomicLong
argument_list|(
literal|0
argument_list|)
decl_stmt|;
DECL|field|updated
specifier|private
specifier|final
name|AtomicLong
name|updated
init|=
operator|new
name|AtomicLong
argument_list|(
literal|0
argument_list|)
decl_stmt|;
DECL|field|created
specifier|private
specifier|final
name|AtomicLong
name|created
init|=
operator|new
name|AtomicLong
argument_list|(
literal|0
argument_list|)
decl_stmt|;
DECL|field|deleted
specifier|private
specifier|final
name|AtomicLong
name|deleted
init|=
operator|new
name|AtomicLong
argument_list|(
literal|0
argument_list|)
decl_stmt|;
DECL|field|noops
specifier|private
specifier|final
name|AtomicLong
name|noops
init|=
operator|new
name|AtomicLong
argument_list|(
literal|0
argument_list|)
decl_stmt|;
DECL|field|batch
specifier|private
specifier|final
name|AtomicInteger
name|batch
init|=
operator|new
name|AtomicInteger
argument_list|(
literal|0
argument_list|)
decl_stmt|;
DECL|field|versionConflicts
specifier|private
specifier|final
name|AtomicLong
name|versionConflicts
init|=
operator|new
name|AtomicLong
argument_list|(
literal|0
argument_list|)
decl_stmt|;
DECL|field|retries
specifier|private
specifier|final
name|AtomicLong
name|retries
init|=
operator|new
name|AtomicLong
argument_list|(
literal|0
argument_list|)
decl_stmt|;
DECL|method|BulkByScrollTask
specifier|public
name|BulkByScrollTask
parameter_list|(
name|long
name|id
parameter_list|,
name|String
name|type
parameter_list|,
name|String
name|action
parameter_list|,
name|Provider
argument_list|<
name|String
argument_list|>
name|description
parameter_list|)
block|{
name|super
argument_list|(
name|id
argument_list|,
name|type
argument_list|,
name|action
argument_list|,
name|description
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getStatus
specifier|public
name|Status
name|getStatus
parameter_list|()
block|{
return|return
operator|new
name|Status
argument_list|(
name|total
operator|.
name|get
argument_list|()
argument_list|,
name|updated
operator|.
name|get
argument_list|()
argument_list|,
name|created
operator|.
name|get
argument_list|()
argument_list|,
name|deleted
operator|.
name|get
argument_list|()
argument_list|,
name|batch
operator|.
name|get
argument_list|()
argument_list|,
name|versionConflicts
operator|.
name|get
argument_list|()
argument_list|,
name|noops
operator|.
name|get
argument_list|()
argument_list|,
name|retries
operator|.
name|get
argument_list|()
argument_list|)
return|;
block|}
comment|/**      * Total number of successfully processed documents.      */
DECL|method|getSuccessfullyProcessed
specifier|public
name|long
name|getSuccessfullyProcessed
parameter_list|()
block|{
return|return
name|updated
operator|.
name|get
argument_list|()
operator|+
name|created
operator|.
name|get
argument_list|()
operator|+
name|deleted
operator|.
name|get
argument_list|()
return|;
block|}
DECL|class|Status
specifier|public
specifier|static
class|class
name|Status
implements|implements
name|Task
operator|.
name|Status
block|{
DECL|field|PROTOTYPE
specifier|public
specifier|static
specifier|final
name|Status
name|PROTOTYPE
init|=
operator|new
name|Status
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
DECL|field|total
specifier|private
specifier|final
name|long
name|total
decl_stmt|;
DECL|field|updated
specifier|private
specifier|final
name|long
name|updated
decl_stmt|;
DECL|field|created
specifier|private
specifier|final
name|long
name|created
decl_stmt|;
DECL|field|deleted
specifier|private
specifier|final
name|long
name|deleted
decl_stmt|;
DECL|field|batches
specifier|private
specifier|final
name|int
name|batches
decl_stmt|;
DECL|field|versionConflicts
specifier|private
specifier|final
name|long
name|versionConflicts
decl_stmt|;
DECL|field|noops
specifier|private
specifier|final
name|long
name|noops
decl_stmt|;
DECL|field|retries
specifier|private
specifier|final
name|long
name|retries
decl_stmt|;
DECL|method|Status
specifier|public
name|Status
parameter_list|(
name|long
name|total
parameter_list|,
name|long
name|updated
parameter_list|,
name|long
name|created
parameter_list|,
name|long
name|deleted
parameter_list|,
name|int
name|batches
parameter_list|,
name|long
name|versionConflicts
parameter_list|,
name|long
name|noops
parameter_list|,
name|long
name|retries
parameter_list|)
block|{
name|this
operator|.
name|total
operator|=
name|checkPositive
argument_list|(
name|total
argument_list|,
literal|"total"
argument_list|)
expr_stmt|;
name|this
operator|.
name|updated
operator|=
name|checkPositive
argument_list|(
name|updated
argument_list|,
literal|"updated"
argument_list|)
expr_stmt|;
name|this
operator|.
name|created
operator|=
name|checkPositive
argument_list|(
name|created
argument_list|,
literal|"created"
argument_list|)
expr_stmt|;
name|this
operator|.
name|deleted
operator|=
name|checkPositive
argument_list|(
name|deleted
argument_list|,
literal|"deleted"
argument_list|)
expr_stmt|;
name|this
operator|.
name|batches
operator|=
name|checkPositive
argument_list|(
name|batches
argument_list|,
literal|"batches"
argument_list|)
expr_stmt|;
name|this
operator|.
name|versionConflicts
operator|=
name|checkPositive
argument_list|(
name|versionConflicts
argument_list|,
literal|"versionConflicts"
argument_list|)
expr_stmt|;
name|this
operator|.
name|noops
operator|=
name|checkPositive
argument_list|(
name|noops
argument_list|,
literal|"noops"
argument_list|)
expr_stmt|;
name|this
operator|.
name|retries
operator|=
name|checkPositive
argument_list|(
name|retries
argument_list|,
literal|"retries"
argument_list|)
expr_stmt|;
block|}
DECL|method|Status
specifier|public
name|Status
parameter_list|(
name|StreamInput
name|in
parameter_list|)
throws|throws
name|IOException
block|{
name|total
operator|=
name|in
operator|.
name|readVLong
argument_list|()
expr_stmt|;
name|updated
operator|=
name|in
operator|.
name|readVLong
argument_list|()
expr_stmt|;
name|created
operator|=
name|in
operator|.
name|readVLong
argument_list|()
expr_stmt|;
name|deleted
operator|=
name|in
operator|.
name|readVLong
argument_list|()
expr_stmt|;
name|batches
operator|=
name|in
operator|.
name|readVInt
argument_list|()
expr_stmt|;
name|versionConflicts
operator|=
name|in
operator|.
name|readVLong
argument_list|()
expr_stmt|;
name|noops
operator|=
name|in
operator|.
name|readVLong
argument_list|()
expr_stmt|;
name|retries
operator|=
name|in
operator|.
name|readVLong
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|writeTo
specifier|public
name|void
name|writeTo
parameter_list|(
name|StreamOutput
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|out
operator|.
name|writeVLong
argument_list|(
name|total
argument_list|)
expr_stmt|;
name|out
operator|.
name|writeVLong
argument_list|(
name|updated
argument_list|)
expr_stmt|;
name|out
operator|.
name|writeVLong
argument_list|(
name|created
argument_list|)
expr_stmt|;
name|out
operator|.
name|writeVLong
argument_list|(
name|deleted
argument_list|)
expr_stmt|;
name|out
operator|.
name|writeVInt
argument_list|(
name|batches
argument_list|)
expr_stmt|;
name|out
operator|.
name|writeVLong
argument_list|(
name|versionConflicts
argument_list|)
expr_stmt|;
name|out
operator|.
name|writeVLong
argument_list|(
name|noops
argument_list|)
expr_stmt|;
name|out
operator|.
name|writeVLong
argument_list|(
name|retries
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|toXContent
specifier|public
name|XContentBuilder
name|toXContent
parameter_list|(
name|XContentBuilder
name|builder
parameter_list|,
name|Params
name|params
parameter_list|)
throws|throws
name|IOException
block|{
name|builder
operator|.
name|startObject
argument_list|()
expr_stmt|;
name|innerXContent
argument_list|(
name|builder
argument_list|,
name|params
argument_list|,
literal|true
argument_list|,
literal|true
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|endObject
argument_list|()
return|;
block|}
DECL|method|innerXContent
specifier|public
name|XContentBuilder
name|innerXContent
parameter_list|(
name|XContentBuilder
name|builder
parameter_list|,
name|Params
name|params
parameter_list|,
name|boolean
name|includeCreated
parameter_list|,
name|boolean
name|includeDeleted
parameter_list|)
throws|throws
name|IOException
block|{
name|builder
operator|.
name|field
argument_list|(
literal|"total"
argument_list|,
name|total
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"updated"
argument_list|,
name|updated
argument_list|)
expr_stmt|;
if|if
condition|(
name|includeCreated
condition|)
block|{
name|builder
operator|.
name|field
argument_list|(
literal|"created"
argument_list|,
name|created
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|includeDeleted
condition|)
block|{
name|builder
operator|.
name|field
argument_list|(
literal|"deleted"
argument_list|,
name|deleted
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|field
argument_list|(
literal|"batches"
argument_list|,
name|batches
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"version_conflicts"
argument_list|,
name|versionConflicts
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"noops"
argument_list|,
name|noops
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"retries"
argument_list|,
name|retries
argument_list|)
expr_stmt|;
return|return
name|builder
return|;
block|}
annotation|@
name|Override
DECL|method|toString
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"BulkIndexByScrollResponse["
argument_list|)
expr_stmt|;
name|innerToString
argument_list|(
name|builder
argument_list|,
literal|true
argument_list|,
literal|true
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|append
argument_list|(
literal|']'
argument_list|)
operator|.
name|toString
argument_list|()
return|;
block|}
DECL|method|innerToString
specifier|public
name|void
name|innerToString
parameter_list|(
name|StringBuilder
name|builder
parameter_list|,
name|boolean
name|includeCreated
parameter_list|,
name|boolean
name|includeDeleted
parameter_list|)
block|{
name|builder
operator|.
name|append
argument_list|(
literal|"updated="
argument_list|)
operator|.
name|append
argument_list|(
name|updated
argument_list|)
expr_stmt|;
if|if
condition|(
name|includeCreated
condition|)
block|{
name|builder
operator|.
name|append
argument_list|(
literal|",created="
argument_list|)
operator|.
name|append
argument_list|(
name|created
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|includeDeleted
condition|)
block|{
name|builder
operator|.
name|append
argument_list|(
literal|",deleted="
argument_list|)
operator|.
name|append
argument_list|(
name|deleted
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|append
argument_list|(
literal|",batches="
argument_list|)
operator|.
name|append
argument_list|(
name|batches
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|",versionConflicts="
argument_list|)
operator|.
name|append
argument_list|(
name|versionConflicts
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|",noops="
argument_list|)
operator|.
name|append
argument_list|(
name|noops
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|",retries="
argument_list|)
operator|.
name|append
argument_list|(
name|retries
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getWriteableName
specifier|public
name|String
name|getWriteableName
parameter_list|()
block|{
return|return
literal|"bulk-by-scroll"
return|;
block|}
annotation|@
name|Override
DECL|method|readFrom
specifier|public
name|Status
name|readFrom
parameter_list|(
name|StreamInput
name|in
parameter_list|)
throws|throws
name|IOException
block|{
return|return
operator|new
name|Status
argument_list|(
name|in
argument_list|)
return|;
block|}
comment|/**          * The total number of documents this request will process. 0 means we don't yet know or, possibly, there are actually 0 documents          * to process. Its ok that these have the same meaning because any request with 0 actual documents should be quite short lived.          */
DECL|method|getTotal
specifier|public
name|long
name|getTotal
parameter_list|()
block|{
return|return
name|total
return|;
block|}
comment|/**          * Count of documents updated.          */
DECL|method|getUpdated
specifier|public
name|long
name|getUpdated
parameter_list|()
block|{
return|return
name|updated
return|;
block|}
comment|/**          * Count of documents created.          */
DECL|method|getCreated
specifier|public
name|long
name|getCreated
parameter_list|()
block|{
return|return
name|created
return|;
block|}
comment|/**          * Count of successful delete operations.          */
DECL|method|getDeleted
specifier|public
name|long
name|getDeleted
parameter_list|()
block|{
return|return
name|deleted
return|;
block|}
comment|/**          * Number of scan responses this request has processed.          */
DECL|method|getBatches
specifier|public
name|int
name|getBatches
parameter_list|()
block|{
return|return
name|batches
return|;
block|}
comment|/**          * Number of version conflicts this request has hit.          */
DECL|method|getVersionConflicts
specifier|public
name|long
name|getVersionConflicts
parameter_list|()
block|{
return|return
name|versionConflicts
return|;
block|}
comment|/**          * Number of noops (skipped bulk items) as part of this request.          */
DECL|method|getNoops
specifier|public
name|long
name|getNoops
parameter_list|()
block|{
return|return
name|noops
return|;
block|}
comment|/**          * Number of retries that had to be attempted due to rejected executions.          */
DECL|method|getRetries
specifier|public
name|long
name|getRetries
parameter_list|()
block|{
return|return
name|retries
return|;
block|}
DECL|method|checkPositive
specifier|private
name|int
name|checkPositive
parameter_list|(
name|int
name|value
parameter_list|,
name|String
name|name
parameter_list|)
block|{
if|if
condition|(
name|value
operator|<
literal|0
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|name
operator|+
literal|" must be greater than 0 but was ["
operator|+
name|value
operator|+
literal|"]"
argument_list|)
throw|;
block|}
return|return
name|value
return|;
block|}
DECL|method|checkPositive
specifier|private
name|long
name|checkPositive
parameter_list|(
name|long
name|value
parameter_list|,
name|String
name|name
parameter_list|)
block|{
if|if
condition|(
name|value
operator|<
literal|0
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|name
operator|+
literal|" must be greater than 0 but was ["
operator|+
name|value
operator|+
literal|"]"
argument_list|)
throw|;
block|}
return|return
name|value
return|;
block|}
block|}
DECL|method|setTotal
name|void
name|setTotal
parameter_list|(
name|long
name|totalHits
parameter_list|)
block|{
name|total
operator|.
name|set
argument_list|(
name|totalHits
argument_list|)
expr_stmt|;
block|}
DECL|method|countBatch
name|void
name|countBatch
parameter_list|()
block|{
name|batch
operator|.
name|incrementAndGet
argument_list|()
expr_stmt|;
block|}
DECL|method|countNoop
name|void
name|countNoop
parameter_list|()
block|{
name|noops
operator|.
name|incrementAndGet
argument_list|()
expr_stmt|;
block|}
DECL|method|countCreated
name|void
name|countCreated
parameter_list|()
block|{
name|created
operator|.
name|incrementAndGet
argument_list|()
expr_stmt|;
block|}
DECL|method|countUpdated
name|void
name|countUpdated
parameter_list|()
block|{
name|updated
operator|.
name|incrementAndGet
argument_list|()
expr_stmt|;
block|}
DECL|method|countDeleted
name|void
name|countDeleted
parameter_list|()
block|{
name|deleted
operator|.
name|incrementAndGet
argument_list|()
expr_stmt|;
block|}
DECL|method|countVersionConflict
name|void
name|countVersionConflict
parameter_list|()
block|{
name|versionConflicts
operator|.
name|incrementAndGet
argument_list|()
expr_stmt|;
block|}
DECL|method|countRetry
name|void
name|countRetry
parameter_list|()
block|{
name|retries
operator|.
name|incrementAndGet
argument_list|()
expr_stmt|;
block|}
block|}
end_class

end_unit

