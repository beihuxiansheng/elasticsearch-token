begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to Elastic Search and Shay Banon under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership. Elastic Search licenses this  * file to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *    http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing,  * software distributed under the License is distributed on an  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  * KIND, either express or implied.  See the License for the  * specific language governing permissions and limitations  * under the License.  */
end_comment

begin_package
DECL|package|org.elasticsearch.river.twitter
package|package
name|org
operator|.
name|elasticsearch
operator|.
name|river
operator|.
name|twitter
package|;
end_package

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|ExceptionsHelper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|action
operator|.
name|ActionListener
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|action
operator|.
name|bulk
operator|.
name|BulkResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|client
operator|.
name|Client
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|client
operator|.
name|Requests
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|client
operator|.
name|action
operator|.
name|bulk
operator|.
name|BulkRequestBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|cluster
operator|.
name|block
operator|.
name|ClusterBlockException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|Strings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|inject
operator|.
name|Inject
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|unit
operator|.
name|TimeValue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|xcontent
operator|.
name|XContentBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|xcontent
operator|.
name|XContentFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|common
operator|.
name|xcontent
operator|.
name|support
operator|.
name|XContentMapValues
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|indices
operator|.
name|IndexAlreadyExistsException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|river
operator|.
name|AbstractRiverComponent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|river
operator|.
name|River
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|river
operator|.
name|RiverName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|river
operator|.
name|RiverSettings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|elasticsearch
operator|.
name|threadpool
operator|.
name|ThreadPool
import|;
end_import

begin_import
import|import
name|twitter4j
operator|.
name|*
import|;
end_import

begin_import
import|import
name|twitter4j
operator|.
name|conf
operator|.
name|ConfigurationBuilder
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicInteger
import|;
end_import

begin_comment
comment|/**  * @author kimchy (shay.banon)  */
end_comment

begin_class
DECL|class|TwitterRiver
specifier|public
class|class
name|TwitterRiver
extends|extends
name|AbstractRiverComponent
implements|implements
name|River
block|{
DECL|field|threadPool
specifier|private
specifier|final
name|ThreadPool
name|threadPool
decl_stmt|;
DECL|field|client
specifier|private
specifier|final
name|Client
name|client
decl_stmt|;
DECL|field|user
specifier|private
specifier|final
name|String
name|user
decl_stmt|;
DECL|field|password
specifier|private
specifier|final
name|String
name|password
decl_stmt|;
DECL|field|indexName
specifier|private
specifier|final
name|String
name|indexName
decl_stmt|;
DECL|field|typeName
specifier|private
specifier|final
name|String
name|typeName
decl_stmt|;
DECL|field|bulkSize
specifier|private
specifier|final
name|int
name|bulkSize
decl_stmt|;
DECL|field|dropThreshold
specifier|private
specifier|final
name|int
name|dropThreshold
decl_stmt|;
DECL|field|filterQuery
specifier|private
name|FilterQuery
name|filterQuery
decl_stmt|;
DECL|field|streamType
specifier|private
name|String
name|streamType
decl_stmt|;
DECL|field|stream
specifier|private
specifier|volatile
name|TwitterStream
name|stream
decl_stmt|;
DECL|field|onGoingBulks
specifier|private
specifier|final
name|AtomicInteger
name|onGoingBulks
init|=
operator|new
name|AtomicInteger
argument_list|()
decl_stmt|;
DECL|field|currentRequest
specifier|private
specifier|volatile
name|BulkRequestBuilder
name|currentRequest
decl_stmt|;
DECL|field|closed
specifier|private
specifier|volatile
name|boolean
name|closed
init|=
literal|false
decl_stmt|;
annotation|@
name|SuppressWarnings
argument_list|(
block|{
literal|"unchecked"
block|}
argument_list|)
DECL|method|TwitterRiver
annotation|@
name|Inject
specifier|public
name|TwitterRiver
parameter_list|(
name|RiverName
name|riverName
parameter_list|,
name|RiverSettings
name|settings
parameter_list|,
name|Client
name|client
parameter_list|,
name|ThreadPool
name|threadPool
parameter_list|)
block|{
name|super
argument_list|(
name|riverName
argument_list|,
name|settings
argument_list|)
expr_stmt|;
name|this
operator|.
name|client
operator|=
name|client
expr_stmt|;
name|this
operator|.
name|threadPool
operator|=
name|threadPool
expr_stmt|;
name|String
name|user
init|=
literal|null
decl_stmt|;
name|String
name|password
init|=
literal|null
decl_stmt|;
name|String
name|oauthConsumerKey
init|=
literal|null
decl_stmt|;
name|String
name|oauthConsumerSecret
init|=
literal|null
decl_stmt|;
name|String
name|oauthAccessToken
init|=
literal|null
decl_stmt|;
name|String
name|oauthAccessTokenSecret
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|settings
operator|.
name|settings
argument_list|()
operator|.
name|containsKey
argument_list|(
literal|"twitter"
argument_list|)
condition|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|twitterSettings
init|=
operator|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
operator|)
name|settings
operator|.
name|settings
argument_list|()
operator|.
name|get
argument_list|(
literal|"twitter"
argument_list|)
decl_stmt|;
name|user
operator|=
name|XContentMapValues
operator|.
name|nodeStringValue
argument_list|(
name|twitterSettings
operator|.
name|get
argument_list|(
literal|"user"
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|password
operator|=
name|XContentMapValues
operator|.
name|nodeStringValue
argument_list|(
name|twitterSettings
operator|.
name|get
argument_list|(
literal|"password"
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
if|if
condition|(
name|twitterSettings
operator|.
name|containsKey
argument_list|(
literal|"oauthConsumerKey"
argument_list|)
condition|)
block|{
name|oauthConsumerKey
operator|=
name|XContentMapValues
operator|.
name|nodeStringValue
argument_list|(
name|twitterSettings
operator|.
name|get
argument_list|(
literal|"oauthConsumerKey"
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|twitterSettings
operator|.
name|containsKey
argument_list|(
literal|"oauthConsumerSecret"
argument_list|)
condition|)
block|{
name|oauthConsumerSecret
operator|=
name|XContentMapValues
operator|.
name|nodeStringValue
argument_list|(
name|twitterSettings
operator|.
name|get
argument_list|(
literal|"oauthConsumerSecret"
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|twitterSettings
operator|.
name|containsKey
argument_list|(
literal|"oauthAccessToken"
argument_list|)
condition|)
block|{
name|oauthAccessToken
operator|=
name|XContentMapValues
operator|.
name|nodeStringValue
argument_list|(
name|twitterSettings
operator|.
name|get
argument_list|(
literal|"oauthAccessToken"
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|twitterSettings
operator|.
name|containsKey
argument_list|(
literal|"oauthAccessTokenSecret"
argument_list|)
condition|)
block|{
name|oauthAccessTokenSecret
operator|=
name|XContentMapValues
operator|.
name|nodeStringValue
argument_list|(
name|twitterSettings
operator|.
name|get
argument_list|(
literal|"oauthAccessTokenSecret"
argument_list|)
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
name|streamType
operator|=
name|XContentMapValues
operator|.
name|nodeStringValue
argument_list|(
name|twitterSettings
operator|.
name|get
argument_list|(
literal|"type"
argument_list|)
argument_list|,
literal|"sample"
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|filterSettings
init|=
operator|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
operator|)
name|twitterSettings
operator|.
name|get
argument_list|(
literal|"filter"
argument_list|)
decl_stmt|;
if|if
condition|(
name|filterSettings
operator|!=
literal|null
condition|)
block|{
name|filterQuery
operator|=
operator|new
name|FilterQuery
argument_list|()
expr_stmt|;
name|filterQuery
operator|.
name|count
argument_list|(
name|XContentMapValues
operator|.
name|nodeIntegerValue
argument_list|(
name|filterSettings
operator|.
name|get
argument_list|(
literal|"count"
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|Object
name|tracks
init|=
name|filterSettings
operator|.
name|get
argument_list|(
literal|"tracks"
argument_list|)
decl_stmt|;
if|if
condition|(
name|tracks
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|tracks
operator|instanceof
name|List
condition|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|lTracks
init|=
operator|(
name|List
argument_list|<
name|String
argument_list|>
operator|)
name|tracks
decl_stmt|;
name|filterQuery
operator|.
name|track
argument_list|(
name|lTracks
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
name|lTracks
operator|.
name|size
argument_list|()
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|filterQuery
operator|.
name|track
argument_list|(
name|Strings
operator|.
name|commaDelimitedListToStringArray
argument_list|(
name|tracks
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|Object
name|follow
init|=
name|filterSettings
operator|.
name|get
argument_list|(
literal|"follow"
argument_list|)
decl_stmt|;
if|if
condition|(
name|follow
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|follow
operator|instanceof
name|List
condition|)
block|{
name|List
name|lFollow
init|=
operator|(
name|List
operator|)
name|follow
decl_stmt|;
name|int
index|[]
name|followIds
init|=
operator|new
name|int
index|[
name|lFollow
operator|.
name|size
argument_list|()
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|lFollow
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|Object
name|o
init|=
name|lFollow
operator|.
name|get
argument_list|(
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|o
operator|instanceof
name|Number
condition|)
block|{
name|followIds
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|Number
operator|)
name|o
operator|)
operator|.
name|intValue
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|followIds
index|[
name|i
index|]
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|o
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
name|filterQuery
operator|.
name|follow
argument_list|(
name|followIds
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|String
index|[]
name|ids
init|=
name|Strings
operator|.
name|commaDelimitedListToStringArray
argument_list|(
name|follow
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|int
index|[]
name|followIds
init|=
operator|new
name|int
index|[
name|ids
operator|.
name|length
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|ids
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|followIds
index|[
name|i
index|]
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|ids
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|Object
name|locations
init|=
name|filterSettings
operator|.
name|get
argument_list|(
literal|"locations"
argument_list|)
decl_stmt|;
if|if
condition|(
name|locations
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|locations
operator|instanceof
name|List
condition|)
block|{
name|List
name|lLocations
init|=
operator|(
name|List
operator|)
name|locations
decl_stmt|;
name|double
index|[]
index|[]
name|dLocations
init|=
operator|new
name|double
index|[
name|lLocations
operator|.
name|size
argument_list|()
index|]
index|[]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|lLocations
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|Object
name|loc
init|=
name|lLocations
operator|.
name|get
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|double
name|lat
decl_stmt|;
name|double
name|lon
decl_stmt|;
if|if
condition|(
name|loc
operator|instanceof
name|List
condition|)
block|{
name|List
name|lLoc
init|=
operator|(
name|List
operator|)
name|loc
decl_stmt|;
if|if
condition|(
name|lLoc
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|instanceof
name|Number
condition|)
block|{
name|lat
operator|=
operator|(
operator|(
name|Number
operator|)
name|lLoc
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|)
operator|.
name|doubleValue
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|lat
operator|=
name|Double
operator|.
name|parseDouble
argument_list|(
name|lLoc
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lLoc
operator|.
name|get
argument_list|(
literal|1
argument_list|)
operator|instanceof
name|Number
condition|)
block|{
name|lon
operator|=
operator|(
operator|(
name|Number
operator|)
name|lLoc
operator|.
name|get
argument_list|(
literal|1
argument_list|)
operator|)
operator|.
name|doubleValue
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|lon
operator|=
name|Double
operator|.
name|parseDouble
argument_list|(
name|lLoc
operator|.
name|get
argument_list|(
literal|1
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|String
index|[]
name|sLoc
init|=
name|Strings
operator|.
name|commaDelimitedListToStringArray
argument_list|(
name|loc
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|lat
operator|=
name|Double
operator|.
name|parseDouble
argument_list|(
name|sLoc
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|lon
operator|=
name|Double
operator|.
name|parseDouble
argument_list|(
name|sLoc
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|dLocations
index|[
name|i
index|]
operator|=
operator|new
name|double
index|[]
block|{
name|lat
block|,
name|lon
block|}
expr_stmt|;
block|}
name|filterQuery
operator|.
name|locations
argument_list|(
name|dLocations
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|String
index|[]
name|sLocations
init|=
name|Strings
operator|.
name|commaDelimitedListToStringArray
argument_list|(
name|locations
operator|.
name|toString
argument_list|()
argument_list|)
decl_stmt|;
name|double
index|[]
index|[]
name|dLocations
init|=
operator|new
name|double
index|[
name|sLocations
operator|.
name|length
operator|/
literal|2
index|]
index|[]
decl_stmt|;
name|int
name|dCounter
init|=
literal|0
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|sLocations
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|double
name|lat
init|=
name|Double
operator|.
name|parseDouble
argument_list|(
name|sLocations
index|[
name|i
index|]
argument_list|)
decl_stmt|;
name|double
name|lon
init|=
name|Double
operator|.
name|parseDouble
argument_list|(
name|sLocations
index|[
operator|++
name|i
index|]
argument_list|)
decl_stmt|;
name|dLocations
index|[
name|dCounter
operator|++
index|]
operator|=
operator|new
name|double
index|[]
block|{
name|lat
block|,
name|lon
block|}
expr_stmt|;
block|}
name|filterQuery
operator|.
name|locations
argument_list|(
name|dLocations
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|logger
operator|.
name|info
argument_list|(
literal|"creating twitter stream river for [{}]"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|this
operator|.
name|user
operator|=
name|user
expr_stmt|;
name|this
operator|.
name|password
operator|=
name|password
expr_stmt|;
if|if
condition|(
name|user
operator|==
literal|null
operator|||
name|password
operator|==
literal|null
condition|)
block|{
name|stream
operator|=
literal|null
expr_stmt|;
name|indexName
operator|=
literal|null
expr_stmt|;
name|typeName
operator|=
literal|"status"
expr_stmt|;
name|bulkSize
operator|=
literal|100
expr_stmt|;
name|dropThreshold
operator|=
literal|10
expr_stmt|;
name|logger
operator|.
name|warn
argument_list|(
literal|"no user / password specified, disabling river..."
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|settings
operator|.
name|settings
argument_list|()
operator|.
name|containsKey
argument_list|(
literal|"index"
argument_list|)
condition|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|indexSettings
init|=
operator|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
operator|)
name|settings
operator|.
name|settings
argument_list|()
operator|.
name|get
argument_list|(
literal|"index"
argument_list|)
decl_stmt|;
name|indexName
operator|=
name|XContentMapValues
operator|.
name|nodeStringValue
argument_list|(
name|indexSettings
operator|.
name|get
argument_list|(
literal|"index"
argument_list|)
argument_list|,
name|riverName
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
name|typeName
operator|=
name|XContentMapValues
operator|.
name|nodeStringValue
argument_list|(
name|indexSettings
operator|.
name|get
argument_list|(
literal|"type"
argument_list|)
argument_list|,
literal|"status"
argument_list|)
expr_stmt|;
name|this
operator|.
name|bulkSize
operator|=
name|XContentMapValues
operator|.
name|nodeIntegerValue
argument_list|(
name|settings
operator|.
name|settings
argument_list|()
operator|.
name|get
argument_list|(
literal|"bulk_size"
argument_list|)
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|this
operator|.
name|dropThreshold
operator|=
name|XContentMapValues
operator|.
name|nodeIntegerValue
argument_list|(
name|settings
operator|.
name|settings
argument_list|()
operator|.
name|get
argument_list|(
literal|"drop_threshold"
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|indexName
operator|=
name|riverName
operator|.
name|name
argument_list|()
expr_stmt|;
name|typeName
operator|=
literal|"status"
expr_stmt|;
name|bulkSize
operator|=
literal|100
expr_stmt|;
name|dropThreshold
operator|=
literal|10
expr_stmt|;
block|}
if|if
condition|(
name|oauthAccessToken
operator|!=
literal|null
operator|&&
name|oauthConsumerKey
operator|!=
literal|null
operator|&&
name|oauthConsumerSecret
operator|!=
literal|null
operator|&&
name|oauthAccessTokenSecret
operator|!=
literal|null
condition|)
block|{
name|ConfigurationBuilder
name|cb
init|=
operator|new
name|ConfigurationBuilder
argument_list|()
decl_stmt|;
name|cb
operator|.
name|setDebugEnabled
argument_list|(
literal|true
argument_list|)
operator|.
name|setOAuthConsumerKey
argument_list|(
name|oauthConsumerKey
argument_list|)
operator|.
name|setOAuthConsumerSecret
argument_list|(
name|oauthConsumerSecret
argument_list|)
operator|.
name|setOAuthAccessToken
argument_list|(
name|oauthAccessToken
argument_list|)
operator|.
name|setOAuthAccessTokenSecret
argument_list|(
name|oauthAccessTokenSecret
argument_list|)
expr_stmt|;
name|stream
operator|=
operator|new
name|TwitterStreamFactory
argument_list|(
name|cb
operator|.
name|build
argument_list|()
argument_list|)
operator|.
name|getInstance
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|stream
operator|=
operator|new
name|TwitterStreamFactory
argument_list|()
operator|.
name|getInstance
argument_list|(
name|user
argument_list|,
name|password
argument_list|)
expr_stmt|;
block|}
name|stream
operator|.
name|addListener
argument_list|(
operator|new
name|StatusHandler
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|start
annotation|@
name|Override
specifier|public
name|void
name|start
parameter_list|()
block|{
if|if
condition|(
name|stream
operator|==
literal|null
condition|)
block|{
return|return;
block|}
name|logger
operator|.
name|info
argument_list|(
literal|"starting twitter stream"
argument_list|)
expr_stmt|;
try|try
block|{
name|String
name|mapping
init|=
name|XContentFactory
operator|.
name|jsonBuilder
argument_list|()
operator|.
name|startObject
argument_list|()
operator|.
name|startObject
argument_list|(
name|typeName
argument_list|)
operator|.
name|startObject
argument_list|(
literal|"properties"
argument_list|)
operator|.
name|startObject
argument_list|(
literal|"location"
argument_list|)
operator|.
name|field
argument_list|(
literal|"type"
argument_list|,
literal|"geo_point"
argument_list|)
operator|.
name|endObject
argument_list|()
operator|.
name|startObject
argument_list|(
literal|"user"
argument_list|)
operator|.
name|startObject
argument_list|(
literal|"properties"
argument_list|)
operator|.
name|startObject
argument_list|(
literal|"screen_name"
argument_list|)
operator|.
name|field
argument_list|(
literal|"type"
argument_list|,
literal|"string"
argument_list|)
operator|.
name|field
argument_list|(
literal|"index"
argument_list|,
literal|"not_analyzed"
argument_list|)
operator|.
name|endObject
argument_list|()
operator|.
name|endObject
argument_list|()
operator|.
name|endObject
argument_list|()
operator|.
name|startObject
argument_list|(
literal|"mention"
argument_list|)
operator|.
name|startObject
argument_list|(
literal|"properties"
argument_list|)
operator|.
name|startObject
argument_list|(
literal|"screen_name"
argument_list|)
operator|.
name|field
argument_list|(
literal|"type"
argument_list|,
literal|"string"
argument_list|)
operator|.
name|field
argument_list|(
literal|"index"
argument_list|,
literal|"not_analyzed"
argument_list|)
operator|.
name|endObject
argument_list|()
operator|.
name|endObject
argument_list|()
operator|.
name|endObject
argument_list|()
operator|.
name|startObject
argument_list|(
literal|"in_reply"
argument_list|)
operator|.
name|startObject
argument_list|(
literal|"properties"
argument_list|)
operator|.
name|startObject
argument_list|(
literal|"user_screen_name"
argument_list|)
operator|.
name|field
argument_list|(
literal|"type"
argument_list|,
literal|"string"
argument_list|)
operator|.
name|field
argument_list|(
literal|"index"
argument_list|,
literal|"not_analyzed"
argument_list|)
operator|.
name|endObject
argument_list|()
operator|.
name|endObject
argument_list|()
operator|.
name|endObject
argument_list|()
operator|.
name|endObject
argument_list|()
operator|.
name|endObject
argument_list|()
operator|.
name|endObject
argument_list|()
operator|.
name|string
argument_list|()
decl_stmt|;
name|client
operator|.
name|admin
argument_list|()
operator|.
name|indices
argument_list|()
operator|.
name|prepareCreate
argument_list|(
name|indexName
argument_list|)
operator|.
name|addMapping
argument_list|(
name|typeName
argument_list|,
name|mapping
argument_list|)
operator|.
name|execute
argument_list|()
operator|.
name|actionGet
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
if|if
condition|(
name|ExceptionsHelper
operator|.
name|unwrapCause
argument_list|(
name|e
argument_list|)
operator|instanceof
name|IndexAlreadyExistsException
condition|)
block|{
comment|// that's fine
block|}
elseif|else
if|if
condition|(
name|ExceptionsHelper
operator|.
name|unwrapCause
argument_list|(
name|e
argument_list|)
operator|instanceof
name|ClusterBlockException
condition|)
block|{
comment|// ok, not recovered yet..., lets start indexing and hope we recover by the first bulk
comment|// TODO: a smarter logic can be to register for cluster event listener here, and only start sampling when the block is removed...
block|}
else|else
block|{
name|logger
operator|.
name|warn
argument_list|(
literal|"failed to create index [{}], disabling river..."
argument_list|,
name|e
argument_list|,
name|indexName
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|currentRequest
operator|=
name|client
operator|.
name|prepareBulk
argument_list|()
expr_stmt|;
if|if
condition|(
name|streamType
operator|.
name|equals
argument_list|(
literal|"filter"
argument_list|)
operator|||
name|filterQuery
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|stream
operator|.
name|filter
argument_list|(
name|filterQuery
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|TwitterException
name|e
parameter_list|)
block|{
name|logger
operator|.
name|warn
argument_list|(
literal|"failed to create filter stream based on query, disabling river...."
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|streamType
operator|.
name|equals
argument_list|(
literal|"firehose"
argument_list|)
condition|)
block|{
name|stream
operator|.
name|firehose
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|stream
operator|.
name|sample
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|reconnect
specifier|private
name|void
name|reconnect
parameter_list|()
block|{
if|if
condition|(
name|closed
condition|)
block|{
return|return;
block|}
try|try
block|{
name|stream
operator|.
name|cleanUp
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|logger
operator|.
name|debug
argument_list|(
literal|"failed to cleanup after failure"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|stream
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|logger
operator|.
name|debug
argument_list|(
literal|"failed to shutdown after failure"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|closed
condition|)
block|{
return|return;
block|}
try|try
block|{
name|stream
operator|=
operator|new
name|TwitterStreamFactory
argument_list|()
operator|.
name|getInstance
argument_list|(
name|user
argument_list|,
name|password
argument_list|)
expr_stmt|;
name|stream
operator|.
name|addListener
argument_list|(
operator|new
name|StatusHandler
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|streamType
operator|.
name|equals
argument_list|(
literal|"filter"
argument_list|)
operator|||
name|filterQuery
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|stream
operator|.
name|filter
argument_list|(
name|filterQuery
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|TwitterException
name|e
parameter_list|)
block|{
name|logger
operator|.
name|warn
argument_list|(
literal|"failed to create filter stream based on query, disabling river...."
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|streamType
operator|.
name|equals
argument_list|(
literal|"firehose"
argument_list|)
condition|)
block|{
name|stream
operator|.
name|firehose
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|stream
operator|.
name|sample
argument_list|()
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
if|if
condition|(
name|closed
condition|)
block|{
name|close
argument_list|()
expr_stmt|;
return|return;
block|}
comment|// TODO, we can update the status of the river to RECONNECT
name|logger
operator|.
name|warn
argument_list|(
literal|"failed to connect after failure, throttling"
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|threadPool
operator|.
name|schedule
argument_list|(
name|TimeValue
operator|.
name|timeValueSeconds
argument_list|(
literal|10
argument_list|)
argument_list|,
name|ThreadPool
operator|.
name|Names
operator|.
name|CACHED
argument_list|,
operator|new
name|Runnable
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
name|reconnect
argument_list|()
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|close
annotation|@
name|Override
specifier|public
name|void
name|close
parameter_list|()
block|{
name|this
operator|.
name|closed
operator|=
literal|true
expr_stmt|;
name|logger
operator|.
name|info
argument_list|(
literal|"closing twitter stream river"
argument_list|)
expr_stmt|;
if|if
condition|(
name|stream
operator|!=
literal|null
condition|)
block|{
name|stream
operator|.
name|cleanUp
argument_list|()
expr_stmt|;
name|stream
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
block|}
DECL|class|StatusHandler
specifier|private
class|class
name|StatusHandler
extends|extends
name|StatusAdapter
block|{
DECL|method|onStatus
annotation|@
name|Override
specifier|public
name|void
name|onStatus
parameter_list|(
name|Status
name|status
parameter_list|)
block|{
if|if
condition|(
name|logger
operator|.
name|isTraceEnabled
argument_list|()
condition|)
block|{
name|logger
operator|.
name|trace
argument_list|(
literal|"status {} : {}"
argument_list|,
name|status
operator|.
name|getUser
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|,
name|status
operator|.
name|getText
argument_list|()
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|XContentBuilder
name|builder
init|=
name|XContentFactory
operator|.
name|jsonBuilder
argument_list|()
operator|.
name|startObject
argument_list|()
decl_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"text"
argument_list|,
name|status
operator|.
name|getText
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"created_at"
argument_list|,
name|status
operator|.
name|getCreatedAt
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"source"
argument_list|,
name|status
operator|.
name|getSource
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"truncated"
argument_list|,
name|status
operator|.
name|isTruncated
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|getUserMentionEntities
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|startArray
argument_list|(
literal|"mention"
argument_list|)
expr_stmt|;
for|for
control|(
name|UserMentionEntity
name|user
range|:
name|status
operator|.
name|getUserMentionEntities
argument_list|()
control|)
block|{
name|builder
operator|.
name|startObject
argument_list|()
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"id"
argument_list|,
name|user
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"name"
argument_list|,
name|user
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"screen_name"
argument_list|,
name|user
operator|.
name|getScreenName
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"start"
argument_list|,
name|user
operator|.
name|getStart
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"end"
argument_list|,
name|user
operator|.
name|getEnd
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|endObject
argument_list|()
expr_stmt|;
block|}
name|builder
operator|.
name|endArray
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|.
name|getRetweetCount
argument_list|()
operator|!=
operator|-
literal|1
condition|)
block|{
name|builder
operator|.
name|field
argument_list|(
literal|"retweet_count"
argument_list|,
name|status
operator|.
name|getRetweetCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|.
name|getInReplyToStatusId
argument_list|()
operator|!=
operator|-
literal|1
condition|)
block|{
name|builder
operator|.
name|startObject
argument_list|(
literal|"in_reply"
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"status"
argument_list|,
name|status
operator|.
name|getInReplyToStatusId
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|getInReplyToUserId
argument_list|()
operator|!=
operator|-
literal|1
condition|)
block|{
name|builder
operator|.
name|field
argument_list|(
literal|"user_id"
argument_list|,
name|status
operator|.
name|getInReplyToUserId
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"user_screen_name"
argument_list|,
name|status
operator|.
name|getInReplyToScreenName
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|endObject
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|.
name|getHashtagEntities
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|startArray
argument_list|(
literal|"hashtag"
argument_list|)
expr_stmt|;
for|for
control|(
name|HashtagEntity
name|hashtag
range|:
name|status
operator|.
name|getHashtagEntities
argument_list|()
control|)
block|{
name|builder
operator|.
name|startObject
argument_list|()
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"text"
argument_list|,
name|hashtag
operator|.
name|getText
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"start"
argument_list|,
name|hashtag
operator|.
name|getStart
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"end"
argument_list|,
name|hashtag
operator|.
name|getEnd
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|endObject
argument_list|()
expr_stmt|;
block|}
name|builder
operator|.
name|endArray
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|.
name|getContributors
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|array
argument_list|(
literal|"contributor"
argument_list|,
name|status
operator|.
name|getContributors
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|.
name|getGeoLocation
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|startObject
argument_list|(
literal|"location"
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"lat"
argument_list|,
name|status
operator|.
name|getGeoLocation
argument_list|()
operator|.
name|getLatitude
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"lon"
argument_list|,
name|status
operator|.
name|getGeoLocation
argument_list|()
operator|.
name|getLongitude
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|endObject
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|.
name|getPlace
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|startObject
argument_list|(
literal|"place"
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"id"
argument_list|,
name|status
operator|.
name|getPlace
argument_list|()
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"name"
argument_list|,
name|status
operator|.
name|getPlace
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"type"
argument_list|,
name|status
operator|.
name|getPlace
argument_list|()
operator|.
name|getPlaceType
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"full_name"
argument_list|,
name|status
operator|.
name|getPlace
argument_list|()
operator|.
name|getFullName
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"street_address"
argument_list|,
name|status
operator|.
name|getPlace
argument_list|()
operator|.
name|getStreetAddress
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"country"
argument_list|,
name|status
operator|.
name|getPlace
argument_list|()
operator|.
name|getCountry
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"country_code"
argument_list|,
name|status
operator|.
name|getPlace
argument_list|()
operator|.
name|getCountryCode
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"url"
argument_list|,
name|status
operator|.
name|getPlace
argument_list|()
operator|.
name|getURL
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|endObject
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|.
name|getURLEntities
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|startArray
argument_list|(
literal|"link"
argument_list|)
expr_stmt|;
for|for
control|(
name|URLEntity
name|url
range|:
name|status
operator|.
name|getURLEntities
argument_list|()
control|)
block|{
if|if
condition|(
name|url
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|startObject
argument_list|()
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"url"
argument_list|,
name|url
operator|.
name|getURL
argument_list|()
operator|.
name|toExternalForm
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|.
name|getDisplayURL
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|field
argument_list|(
literal|"display_url"
argument_list|,
name|url
operator|.
name|getDisplayURL
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|url
operator|.
name|getExpandedURL
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|field
argument_list|(
literal|"expand_url"
argument_list|,
name|url
operator|.
name|getExpandedURL
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|field
argument_list|(
literal|"start"
argument_list|,
name|url
operator|.
name|getStart
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"end"
argument_list|,
name|url
operator|.
name|getEnd
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|endObject
argument_list|()
expr_stmt|;
block|}
block|}
name|builder
operator|.
name|endArray
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|.
name|getAnnotations
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|startObject
argument_list|(
literal|"annotation"
argument_list|)
expr_stmt|;
for|for
control|(
name|Annotation
name|ann
range|:
name|status
operator|.
name|getAnnotations
argument_list|()
operator|.
name|getAnnotations
argument_list|()
control|)
block|{
name|builder
operator|.
name|startObject
argument_list|(
name|ann
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|entry
range|:
name|ann
operator|.
name|getAttributes
argument_list|()
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|builder
operator|.
name|field
argument_list|(
name|entry
operator|.
name|getKey
argument_list|()
argument_list|,
name|entry
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|endObject
argument_list|()
expr_stmt|;
block|}
name|builder
operator|.
name|endObject
argument_list|()
expr_stmt|;
block|}
name|builder
operator|.
name|startObject
argument_list|(
literal|"user"
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"id"
argument_list|,
name|status
operator|.
name|getUser
argument_list|()
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"name"
argument_list|,
name|status
operator|.
name|getUser
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"screen_name"
argument_list|,
name|status
operator|.
name|getUser
argument_list|()
operator|.
name|getScreenName
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"location"
argument_list|,
name|status
operator|.
name|getUser
argument_list|()
operator|.
name|getLocation
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|field
argument_list|(
literal|"description"
argument_list|,
name|status
operator|.
name|getUser
argument_list|()
operator|.
name|getDescription
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|endObject
argument_list|()
expr_stmt|;
name|builder
operator|.
name|endObject
argument_list|()
expr_stmt|;
name|currentRequest
operator|.
name|add
argument_list|(
name|Requests
operator|.
name|indexRequest
argument_list|(
name|indexName
argument_list|)
operator|.
name|type
argument_list|(
name|typeName
argument_list|)
operator|.
name|id
argument_list|(
name|Long
operator|.
name|toString
argument_list|(
name|status
operator|.
name|getId
argument_list|()
argument_list|)
argument_list|)
operator|.
name|create
argument_list|(
literal|true
argument_list|)
operator|.
name|source
argument_list|(
name|builder
argument_list|)
argument_list|)
expr_stmt|;
name|processBulkIfNeeded
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|logger
operator|.
name|warn
argument_list|(
literal|"failed to construct index request"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|onDeletionNotice
annotation|@
name|Override
specifier|public
name|void
name|onDeletionNotice
parameter_list|(
name|StatusDeletionNotice
name|statusDeletionNotice
parameter_list|)
block|{
if|if
condition|(
name|statusDeletionNotice
operator|.
name|getStatusId
argument_list|()
operator|!=
operator|-
literal|1
condition|)
block|{
name|currentRequest
operator|.
name|add
argument_list|(
name|Requests
operator|.
name|deleteRequest
argument_list|(
name|indexName
argument_list|)
operator|.
name|type
argument_list|(
name|typeName
argument_list|)
operator|.
name|id
argument_list|(
name|Long
operator|.
name|toString
argument_list|(
name|statusDeletionNotice
operator|.
name|getStatusId
argument_list|()
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|processBulkIfNeeded
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|onTrackLimitationNotice
annotation|@
name|Override
specifier|public
name|void
name|onTrackLimitationNotice
parameter_list|(
name|int
name|numberOfLimitedStatuses
parameter_list|)
block|{
name|logger
operator|.
name|info
argument_list|(
literal|"received track limitation notice, number_of_limited_statuses {}"
argument_list|,
name|numberOfLimitedStatuses
argument_list|)
expr_stmt|;
block|}
DECL|method|onException
annotation|@
name|Override
specifier|public
name|void
name|onException
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
name|logger
operator|.
name|warn
argument_list|(
literal|"stream failure, restarting stream..."
argument_list|,
name|ex
argument_list|)
expr_stmt|;
name|threadPool
operator|.
name|cached
argument_list|()
operator|.
name|execute
argument_list|(
operator|new
name|Runnable
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
name|reconnect
argument_list|()
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
DECL|method|processBulkIfNeeded
specifier|private
name|void
name|processBulkIfNeeded
parameter_list|()
block|{
if|if
condition|(
name|currentRequest
operator|.
name|numberOfActions
argument_list|()
operator|>=
name|bulkSize
condition|)
block|{
comment|// execute the bulk operation
name|int
name|currentOnGoingBulks
init|=
name|onGoingBulks
operator|.
name|incrementAndGet
argument_list|()
decl_stmt|;
if|if
condition|(
name|currentOnGoingBulks
operator|>
name|dropThreshold
condition|)
block|{
name|onGoingBulks
operator|.
name|decrementAndGet
argument_list|()
expr_stmt|;
name|logger
operator|.
name|warn
argument_list|(
literal|"dropping bulk, [{}] crossed threshold [{}]"
argument_list|,
name|onGoingBulks
argument_list|,
name|dropThreshold
argument_list|)
expr_stmt|;
block|}
else|else
block|{
try|try
block|{
name|currentRequest
operator|.
name|execute
argument_list|(
operator|new
name|ActionListener
argument_list|<
name|BulkResponse
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|onResponse
parameter_list|(
name|BulkResponse
name|bulkResponse
parameter_list|)
block|{
name|onGoingBulks
operator|.
name|decrementAndGet
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|onFailure
parameter_list|(
name|Throwable
name|e
parameter_list|)
block|{
name|logger
operator|.
name|warn
argument_list|(
literal|"failed to execute bulk"
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|logger
operator|.
name|warn
argument_list|(
literal|"failed to process bulk"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
name|currentRequest
operator|=
name|client
operator|.
name|prepareBulk
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
end_class

end_unit

